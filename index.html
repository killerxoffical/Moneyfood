<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta tag to color the browser UI -->
    <meta name="theme-color" content="#FFFFFF" id="theme-color-meta">
    <title>Money Food - Premium</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* GLOBAL VARIABLES & THEME */
        :root {
            --primary: #FF5722; 
            --primary-dark: #E64A19;
            --success: #00C853; 
            --danger: #FF3D00;
            --radius: 16px;
            --bg-body: #F4F6F8; 
            --bg-card: #FFFFFF;
            --text-main: #1C1C1E;
            --text-muted: #6c757d;
            --border-color: #E0E0E0;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --input-bg: #F8F9FA;
            --stepper-inactive: #e0e0e0;
            --glass: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] {
            --bg-body: #050505;
            --bg-card: #151515;
            --text-main: #FFFFFF;
            --text-muted: #B0B0B0;
            --border-color: #333333;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --input-bg: #222222;
            --stepper-inactive: #444444;
            --glass: rgba(20, 20, 20, 0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', 'Hind Siliguri', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-main); padding-bottom: 90px; transition: background 0.3s, color 0.3s; overflow-x: hidden; }
        body.no-scroll { overflow: hidden; } 
        body.hide-nav { padding-bottom: 0; }
        body.hide-nav .bottom-nav { transform: translateY(120%); }

        .hidden { display: none !important; }

        /* PAGE TRANSITION ANIMATIONS */
        .page-section { animation: fadeInRight 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both; width: 100%; min-height: 100vh; padding-bottom: 100px; }
        @keyframes fadeInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        
        /* COMPONENTS */
        .btn { padding: 14px 20px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(255, 87, 34, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-outline { border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-main); }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; width: auto; border-radius: 8px; }
        .btn.disabled { background: #ccc; color: #666; pointer-events: none; box-shadow: none; }
        
        .form-control { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 12px; outline: none; transition: 0.3s; font-size: 1rem; background: var(--input-bg); margin-bottom: 15px; color: var(--text-main); }
        .form-control:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px rgba(255, 87, 34, 0.1); }
        
        /* Header Styles */
        header { background: var(--bg-card); padding: 8px 15px; height: 65px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 15px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .app-logo { font-size: 1.2rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; }
        .app-logo img { width: 48px; height: 48px; object-fit: contain; }
        
        .search-icon-wrapper { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: var(--input-bg); color: var(--text-main); font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .search-icon-wrapper:active { transform: scale(0.9); background: var(--border-color); }

        .search-overlay { position: fixed; top: 65px; left: 0; width: 100%; background: var(--bg-card); padding: 15px; z-index: 99; box-shadow: 0 10px 20px rgba(0,0,0,0.1); transform: translateY(-150%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-bottom: 1px solid var(--border-color); display:flex; flex-direction:column; max-height: 80vh; }
        .search-overlay.active { transform: translateY(0); }
        .header-search-input { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); padding: 12px 15px; border-radius: 12px; font-size: 1rem; color: var(--text-main); outline: none; margin-bottom: 10px; }
        .search-suggestions-list { overflow-y: auto; flex: 1; display: none; }
        .search-suggestions-list.has-results { display: block; }
        .suggestion-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: 0.2s; }
        .sugg-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; margin-right: 12px; }
        .sugg-name { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        .sugg-price { font-size: 0.8rem; color: var(--primary); font-weight: 700; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .page-header h3 { font-size: 1.4rem; font-weight: 700; color: var(--text-main); }
        
        /* RESTAURANT STYLES */
        .restaurant-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .restaurant-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); overflow: hidden; cursor: pointer; transition: transform 0.2s; position: relative; }
        .restaurant-card.offline { opacity: 0.5; filter: grayscale(80%); cursor: not-allowed; }
        .restaurant-card:active { transform: scale(0.98); }
        .restaurant-banner { width: 100%; height: 160px; object-fit: cover; }
        .restaurant-info { padding: 15px; }
        .restaurant-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .restaurant-meta { font-size: 0.85rem; color: var(--text-muted); display: flex; flex-direction: column; gap: 5px; }
        .meta-row { display: flex; justify-content: space-between; align-items: center; }
        .delivery-pill { display: flex; align-items: center; gap: 6px; font-weight: 500; }
        .savings-pill { font-weight: 800; color: var(--primary); font-size: 0.8rem; background: rgba(255, 87, 34, 0.1); padding: 2px 8px; border-radius: 6px; }
        .offline-badge { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }

        /* RESTAURANT MENU PAGE */
        #page-restaurant-menu { padding: 0; background-color: var(--bg-body); }
        .menu-hero-section { position: relative; height: 200px; overflow: hidden; }
        .menu-hero-bg { position: absolute; inset: 0; background-size: cover; background-position: center; transition: transform 0.4s ease; }
        .menu-hero-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0.1)); }
        .menu-hero-content { position: absolute; bottom: 15px; left: 20px; right: 20px; color: white; }
        .menu-hero-title { font-size: 1.6rem; font-weight: 800; line-height: 1.2; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .menu-hero-desc { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }
        .menu-product-container { background: var(--bg-body); border-radius: 24px 24px 0 0; margin-top: -20px; position: relative; z-index: 5; padding: 20px; }
        
        /* NEW: Premium Nav on Menu Page */
        .menu-hero-nav { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .menu-hero-btn { 
            width: 42px; 
            height: 42px; 
            background: var(--primary); /* CHANGED: Orange background */
            backdrop-filter: blur(5px); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; /* CHANGED: White icon color */
            font-size: 1rem; 
            cursor: pointer; 
            border: 1px solid rgba(255,255,255,0.3); 
            transition: transform 0.2s; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Added shadow for depth */
        }
        .menu-hero-btn:active { transform: scale(0.95); }
        .menu-cart-icon { position: relative; }
        .menu-cart-badge { position: absolute; top: -2px; right: -2px; background: var(--danger); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; border: 2px solid rgba(30,30,30,0.5); display: none; }

        .sticky-filter-bar { position: sticky; top: 65px; z-index: 8; background: var(--bg-body); padding-top: 10px; margin-bottom: 10px; transition: background 0.3s; }
        
        /* GLOBAL FULL SCREEN CART */
        #page-global-cart { padding: 0; }
        #global-cart-items { padding: 20px; }

        .cart-restaurant-summary { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .crs-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; }
        .crs-logo { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; }
        .crs-name { font-size: 1.2rem; font-weight: 700; flex: 1; }
        .crs-item-preview-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .crs-item-preview { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .crs-item-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
        
        /* GENERAL STYLES */
        .chat-notification-banner { position: fixed; top: 65px; left: 50%; transform: translateX(-50%) translateY(-150%); width: 95%; max-width: 450px; background: var(--bg-card); border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; padding: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); z-index: 90; display: flex; align-items: center; justify-content: space-between; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); cursor: pointer; border: 1px solid var(--border-color); border-top: none; }
        .chat-notification-banner.active { transform: translateX(-50%) translateY(0); }
        .chat-notif-content { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
        .chat-notif-icon { width: 40px; height: 40px; background: rgba(255,87,34,0.15); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; animation: pulse-orange 2s infinite; }
        .chat-notif-text { display: flex; flex-direction: column; flex: 1; min-width: 0; }
        .chat-notif-title { font-size: 0.9rem; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }
        .chat-notif-msg { font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;}
        .chat-notif-actions { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .chat-badge-stack { background: var(--danger); color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; font-weight: 800; }
        .chat-close-notif { color: #999; font-size: 1.2rem; padding: 5px; cursor: pointer; transition: 0.2s; }
        .chat-close-notif:hover { color: var(--danger); }

        .custom-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .custom-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .custom-modal-card { background: var(--bg-card); width: 85%; max-width: 320px; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: scale(0.8); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid var(--border-color); }
        .custom-modal-overlay.active .custom-modal-card { transform: scale(1); }
        .cm-icon { font-size: 3rem; margin-bottom: 15px; color: var(--primary); }
        .cm-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; color: var(--text-main); }
        .cm-desc { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }
        .cm-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 50px; font-weight: 600; width: 100%; cursor: pointer; font-size: 0.95rem; box-shadow: 0 5px 15px rgba(255,87,34,0.3); }

        .loyalty-card { background: linear-gradient(135deg, #212121, #000000); border-radius: 20px; padding: 20px; color: white; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); position: relative; overflow: hidden; border: 1px solid #333; }
        [data-theme="light"] .loyalty-card { background: linear-gradient(135deg, #FF5722, #FF8A65); border: none; box-shadow: 0 10px 25px rgba(255, 87, 34, 0.3); }
        .loyalty-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; position: relative; z-index: 2; }
        .loyalty-title { font-size: 1.1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .loyalty-desc { font-size: 0.8rem; opacity: 0.9; margin-top: 2px; max-width: 80%; }
        .loyalty-icon { font-size: 2.5rem; opacity: 0.2; position: absolute; right: 0; top: 0; transform: rotate(15deg); }
        .track-container { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; margin-top: 10px; }
        .track-step { width: 35px; height: 35px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; position: relative; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.3); }
        .track-step.filled { background: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .track-step.filled i { color: #FF5722 !important; }
        .track-step.free-step { width: 45px; height: 45px; border: 2px solid #FFD700; background: rgba(255, 215, 0, 0.2); color: #FFD700; }
        .track-step.free-step.active { background: #FFD700; color: #000; box-shadow: 0 0 15px #FFD700; animation: pulse-gold 1.5s infinite; }
        .track-line { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: rgba(255,255,255,0.2); z-index: -1; transform: translateY(-50%); }
        .track-progress { position: absolute; top: 50%; left: 0; height: 2px; background: white; z-index: -1; transform: translateY(-50%); transition: width 0.5s; }
        @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }

        .file-upload-wrapper { position: relative; width: 100%; height: 120px; border: 2px dashed var(--border-color); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--input-bg); cursor: pointer; transition: 0.3s; }
        .custom-file-input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .multi-img-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .img-slot { height: 80px; border: 2px dashed var(--border-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; background: var(--input-bg); }
        .img-slot img { width: 100%; height: 100%; object-fit: cover; }
        .slot-del { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; cursor: pointer; }
        .cart-item-img { width: 50px; height: 50px; border-radius: 12px; border: 1px solid var(--border-color); object-fit: cover; background: var(--bg-card); flex-shrink: 0; }

        .swipe-container { position: relative; width: 100%; height: 60px; background: #e0e0e0; border-radius: 30px; margin: 20px 0 30px 0; overflow: hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
        [data-theme="dark"] .swipe-container { background: #333; }
        .swipe-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--text-muted); font-size: 1rem; pointer-events: none; z-index: 1; letter-spacing: 1px; text-transform: uppercase; }
        .swipe-handle { position: absolute; left: 0; top: 0; height: 60px; width: 70px; background: var(--primary); border-radius: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; box-shadow: 0 0 10px rgba(255,87,34,0.4); z-index: 2; transition: background 0.2s; }
        .swipe-handle:active { background: var(--primary-dark); }
        .swipe-bg-active { position: absolute; left: 0; top: 0; height: 100%; width: 0; background: rgba(255,87,34,0.2); z-index: 0; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .shake-it { animation: shake 0.3s ease-in-out; border: 2px solid red; }

        .savings-card { background: #101010; border-radius: 16px; padding: 0; margin-bottom: 25px; position: relative; overflow: hidden; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 1px solid #333; }
        .savings-banner { width: 100%; height: 90px; object-fit: cover; opacity: 0.8; }
        .savings-content { padding: 15px; position: relative; z-index: 2; }
        .savings-title { text-align: center; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; color: #ccc; font-weight: 600; }
        .compare-grid { display: flex; justify-content: space-between; align-items: flex-end; position: relative; padding: 0 10px; }
        .compare-grid::after { content: ''; position: absolute; left: 50%; top: 10px; bottom: 10px; width: 1px; background: #444; }
        .compare-item { text-align: center; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .compare-logo { width: 50px; height: 50px; border-radius: 50%; margin-bottom: 8px; object-fit: cover; border: 2px solid #333; background: #fff; }
        .compare-name { font-size: 0.75rem; color: #aaa; margin-bottom: 4px; }
        .compare-price { font-size: 1.2rem; font-weight: 700; }
        .price-mf { color: #FF5722; }
        .price-other { color: #aaa; text-decoration: line-through; font-size: 1rem; }
        .you-save-pill { background: white; color: #101010; font-weight: 800; padding: 8px 20px; border-radius: 30px; margin: 20px auto 5px auto; width: fit-content; display: block; font-size: 0.95rem; box-shadow: 0 5px 15px rgba(255,255,255,0.2); }

        .premium-location-box { background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px dashed #2196F3; padding: 15px; border-radius: 16px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; margin-bottom: 5px; }
        .premium-location-box:active { transform: scale(0.98); }
        .premium-location-box.active { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-color: #00C853; }
        .premium-location-box i { color: var(--primary); }
        .loc-title { font-size: 0.95rem; font-weight: 700; color: #1565C0; margin-bottom: 5px; }
        .premium-location-box.active .loc-title { color: #2E7D32; }
        .loc-subtitle { font-size: 0.8rem; color: #555; }
        .map-preview-frame { width: 100%; height: 180px; border: none; border-radius: 12px; margin-top: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .map-address-display { font-size: 0.85rem; color: var(--text-muted); background: var(--input-bg); padding: 10px; border-radius: 8px; margin-top: 5px; border: 1px solid var(--border-color); text-align: center; }
        .loc-bengali-note { font-size: 0.8rem; color: var(--text-muted); text-align: center; margin-bottom: 15px; background: var(--bg-card); border: 1px solid var(--border-color); padding: 8px; border-radius: 8px; }

        .addr-glass-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .live-loc-btn-lg { width: 100%; padding: 20px; background: linear-gradient(135deg, #FF5722, #FF8A65); color: white; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 15px; cursor: pointer; box-shadow: 0 8px 20px rgba(255,87,34,0.3); transition: transform 0.2s; margin-bottom: 8px; }
        .live-loc-btn-lg:active { transform: scale(0.97); }
        .loc-pulse { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; animation: pulse-white 1.5s infinite; }
        @keyframes pulse-white { 0% {box-shadow: 0 0 0 0 rgba(255,255,255, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(255,255,255, 0);} 100% {box-shadow: 0 0 0 0 rgba(255,255,255, 0);} }
        .detected-map-box { width: 100%; height: 200px; background: #eee; border-radius: 16px; overflow: hidden; margin-bottom: 15px; border: 2px solid var(--primary); position: relative; display: none; }
        .detected-address-text { background: var(--input-bg); padding: 15px; border-radius: 12px; border-left: 4px solid var(--primary); font-size: 0.9rem; color: var(--text-main); margin-bottom: 20px; display: none; }

        #success-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; opacity: 0; pointer-events: none; transition: 0.3s; }
        .checkmark-circle { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #00C853; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .checkmark-icon { font-size: 40px; color: #00C853; }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        #splash-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #FF5722, #FF8A65); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; transition: opacity 0.8s ease-out; }
        #splash-screen.fade-out { opacity: 0; pointer-events: none; }
        .splash-logo-container { width: 180px; height: 180px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: pulse 2s infinite; margin-bottom: 25px; padding: 0; overflow: hidden; }
        .splash-logo-img { width: 100%; height: 100%; object-fit: cover; }
        .splash-title { font-size: 2.2rem; font-weight: 800; letter-spacing: 1px; margin-bottom: 5px; }
        .splash-tagline { font-size: 1.1rem; opacity: 0.9; font-weight: 300; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }

        .profile-premium-card { background: linear-gradient(135deg, #1e1e1e, #2a2a2a); border-radius: 24px; padding: 25px; display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; margin-bottom: 25px; }
        [data-theme="light"] .profile-premium-card { background: linear-gradient(135deg, #ffffff, #f8f9fa); border: 1px solid #eee; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .profile-premium-card::before { content:''; position: absolute; top:-20px; right:-20px; width:100px; height:100px; background: var(--primary); opacity: 0.1; border-radius: 50%; }
        .profile-avatar-premium { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary); padding: 3px; background: var(--bg-card); object-fit: cover; box-shadow: 0 5px 15px rgba(255,87,34,0.2); position: relative; z-index: 2; }
        .profile-info-premium { flex: 1; position: relative; z-index: 2; }
        .profile-name-premium { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 2px; }
        .profile-email-premium { font-size: 0.85rem; color: var(--text-muted); opacity: 0.9; }
        .profile-edit-badge { position: absolute; top: 15px; right: 15px; color: var(--primary); font-size: 1rem; cursor: pointer; }

        .address-display-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); transition: 0.3s; }
        .address-info-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .address-icon-box { width: 45px; height: 45px; background: rgba(255, 87, 34, 0.1); color: var(--primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .address-text-content { display: flex; flex-direction: column; }
        .addr-area-title { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .addr-detail-text { font-size: 0.85rem; color: var(--text-muted); display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .address-edit-btn { padding: 8px 12px; border-radius: 8px; background: var(--input-bg); color: var(--primary); font-size: 0.9rem; cursor: pointer; border: 1px solid var(--border-color); margin-left: 10px; }
        .profile-menu-item { background: var(--bg-card); padding: 18px; border-radius: 14px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer; display: flex; align-items: center; gap: 15px; font-weight: 500; transition: 0.2s; color: var(--text-main); border: 1px solid var(--border-color); }
        .profile-menu-item i { color: var(--primary); font-size: 1.1rem; }
        
        .savings-report-card { background: linear-gradient(135deg, #1e1e1e, #333); border-radius: 16px; padding: 20px; color: white; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 1px solid #444; }
        .savings-header { font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; text-align: center; color: #ccc; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 0; position: relative;}
        .savings-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .sav-box { background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px 5px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .sav-val { font-size: 0.95rem; font-weight: 700; display: block; margin-bottom: 2px; }
        .sav-lbl { font-size: 0.65rem; color: #aaa; text-transform: uppercase; }
        .total-savings-banner { background: linear-gradient(90deg, #00C853, #69F0AE); color: #101010; padding: 15px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(0,200,83,0.3); text-transform: uppercase; }

        .savings-header-wrapper { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
        .savings-info-icon { font-family: 'Times New Roman', serif; font-weight: bold; font-style: italic; width: 22px; height: 22px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #777; transition: transform 0.2s; }
        .savings-popup-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); z-index: 8000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .savings-popup-overlay.active { opacity: 1; pointer-events: auto; }
        .savings-popup-content { background: linear-gradient(135deg, #2a2a2a, #1e1e1e); color: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 380px; border: 1px solid #555; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; transform: scale(0.5); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .savings-popup-overlay.active .savings-popup-content { transform: scale(1); }
        .popup-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 20px; color: var(--primary); }
        .comparison-row { display: flex; justify-content: space-between; padding: 12px 0; font-size: 0.95rem; border-bottom: 1px dashed #444; }
        .comparison-row:last-of-type { border-bottom: none; }
        .comparison-row span:first-child { color: #bbb; }
        .comparison-row span:last-child { font-weight: 700; }
        .other-company-price { text-decoration: line-through; color: #999; }
        .money-food-price { color: #fff; }
        .total-saved-popup { background: #00C853; color: #101010; padding: 10px 15px; border-radius: 12px; font-size: 1.1rem; font-weight: 800; margin: 15px 0; }
        .company-slogan { font-size: 0.85rem; color: #ccc; line-height: 1.6; margin-top: 20px; }
        .popup-close-btn { margin-top: 20px; padding: 10px 30px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: 700; cursor: pointer; }

        .theme-toggle-wrapper { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .theme-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* NEW: CART REVIEW MODAL */
        .cr-item-row { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .cr-item-info { flex: 1; }
        .cr-item-name { font-size: 1rem; font-weight: 600; }
        .cr-item-price { font-size: 0.85rem; color: var(--text-muted); }
        .cr-qty-val { font-size: 1.1rem; font-weight: 700; min-width: 25px; text-align: center; }

        .filters { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; -ms-overflow-style: none; }
        .filters::-webkit-scrollbar { display: none; }
        .filter-chip { padding: 10px 20px; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); border-radius: 25px; white-space: nowrap; font-size: 0.9rem; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(255, 87, 34, 0.2); }
        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .product-card { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; transition: transform 0.2s; border: 1px solid var(--border-color); cursor: pointer; }
        .product-card:active { transform: scale(0.98); }
        .product-img { width: 100%; height: 140px; object-fit: cover; background: #f0f0f0; }
        .product-info { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; }
        .product-name { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; color: var(--text-main); }
        .product-meta { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
        .product-price { color: var(--primary); font-weight: 700; font-size: 1.05rem; }
        .btn-add { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3); }

        .checkout-item-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--border-color); }
        .checkout-item-row:last-child { border-bottom: none; }
        .co-item-name { font-size: 0.9rem; font-weight: 500; flex: 1; padding-right: 10px; }
        .co-item-controls { display: flex; align-items: center; gap: 15px; }
        .co-item-price { font-size: 0.85rem; color: var(--text-muted); min-width: 50px; text-align: right; }
        .co-item-qty { font-weight: 700; font-size: 1rem; }

        .checkout-box { background: var(--bg-card); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .section-title { font-size: 1rem; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; color: var(--text-main); }
        .section-title i { color: var(--primary); }
        .bill-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; color: var(--text-muted); }
        .bill-row.grand-total { font-weight: 800; font-size: 1.3rem; color: var(--text-main); border-top: 2px dashed var(--border-color); padding-top: 15px; margin-top: 15px; margin-bottom: 0; align-items: center; }
        .bill-row.grand-total span:last-child { color: var(--primary); }
        .delivery-options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .del-opt-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; cursor: pointer; text-align: center; transition: 0.2s; background: var(--bg-card); position: relative; overflow: hidden; }
        .del-opt-card.active { border: 2px solid var(--primary); background: #fff3e0; }
        [data-theme="dark"] .del-opt-card.active { background: rgba(255, 87, 34, 0.15); }
        .del-opt-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; }
        .del-opt-price { font-size: 0.85rem; color: var(--primary); font-weight: 600; }
        .del-opt-badge { font-size: 0.7rem; background: #e0e0e0; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 5px; }
        .del-opt-card.active .del-opt-badge { background: var(--primary); color: white; }
        .tip-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .tip-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 10px 5px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; background: var(--bg-card); }
        .tip-card.selected { border-color: var(--primary); background: #fff3e0; }
        [data-theme="dark"] .tip-card.selected { background: rgba(255, 87, 34, 0.2); }
        .tip-emoji { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        .tip-amount { font-weight: 700; font-size: 0.9rem; color: var(--text-main); }
        .tip-card.selected .tip-amount { color: var(--primary); }
        .rider-note-box { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 12px; font-size: 0.9rem; color: var(--text-main); outline: none; transition: 0.3s; margin-top: 10px; resize: none; }
        .rider-note-box:focus { border-color: var(--primary); background: var(--bg-card); }
        .pay-option { display: flex; align-items: center; padding: 15px; border: 1px solid var(--border-color); border-radius: 14px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; background: var(--bg-card); }
        .pay-option.selected { border: 2px solid var(--primary); background: #fffbf9; box-shadow: 0 4px 10px rgba(255,87,34,0.05); }
        [data-theme="dark"] .pay-option.selected { background: rgba(255, 87, 34, 0.1); }
        .pay-icon { width: 40px; height: 40px; background: var(--input-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--primary); margin-right: 15px; }
        .pay-info { flex: 1; }
        .pay-title { font-weight: 600; font-size: 0.95rem; display: block; color: var(--text-main); }
        .pay-desc { font-size: 0.75rem; color: var(--text-muted); }
        .radio-circle { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; position: relative; }
        .pay-option.selected .radio-circle { border-color: var(--primary); }
        .pay-option.selected .radio-circle::after { content: ''; position: absolute; inset: 3px; background: var(--primary); border-radius: 50%; }

        .edit-profile-card { background: var(--bg-card); padding: 30px 20px; border-radius: 24px; box-shadow: var(--shadow); border: 1px solid var(--border-color); position: relative; margin-top: 10px; }
        .edit-prof-header { text-align: center; margin-bottom: 25px; }
        .edit-prof-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--bg-card); box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 10px; background: #eee; }
        .edit-input-group { margin-bottom: 20px; }
        .edit-label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; display: block; margin-left: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .edit-input { width: 100%; padding: 16px; border-radius: 14px; border: 2px solid var(--input-bg); background: var(--input-bg); font-size: 1rem; color: var(--text-main); font-weight: 500; transition: 0.3s; outline: none; }
        .edit-input:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 5px 15px rgba(255,87,34,0.1); }

        .order-card-new { background: var(--bg-card); border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 25px; overflow: hidden; position: relative; border: 1px solid var(--border-color); }
        .order-banner { width: 100%; height: 130px; object-fit: cover; display: block; }
        .order-header-info { padding: 15px; border-bottom: 1px solid var(--border-color); background: var(--bg-card); }
        .order-code-lg { font-size: 1.1rem; font-weight: 800; color: var(--text-main); display: block; margin-bottom: 2px; }
        .order-date-sm { font-size: 0.85rem; color: var(--text-muted); }
        .stepper-wrapper { padding: 20px 10px; background: var(--bg-card); }
        .stepper { display: flex; justify-content: space-between; position: relative; }
        .stepper::before { content: ''; position: absolute; top: 15px; left: 10%; right: 10%; height: 3px; background: var(--stepper-inactive); z-index: 0; }
        .step { position: relative; z-index: 1; text-align: center; width: 25%; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background: var(--stepper-inactive); margin: 0 auto 8px; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 3px solid var(--bg-card); transition: 0.3s; }
        .step-label { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; }
        .step.active .step-circle { background: var(--success); }
        .step.active .step-label { color: var(--success); }
        .step.pending .step-circle { background: var(--success); }
        .step.cancelled .step-circle { background: #F44336; }
        .step.cancelled .step-label { color: #F44336; }
        .order-items-toggle { padding: 15px; background: var(--input-bg); cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.95rem; color: var(--text-main); border-top: 1px solid var(--border-color); }
        .order-items-list { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: var(--bg-card); }
        .order-items-list.expanded { max-height: 800px; padding: 15px; border-bottom: 1px solid var(--border-color); }
        .item-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .item-thumb { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; margin-right: 12px; background: #eee; border: 2px solid var(--primary); }
        .item-details { flex: 1; font-size: 0.9rem; color: var(--text-main); }
        .item-price { font-weight: 600; color: var(--text-main); }
        .total-bill-row { display: flex; justify-content: space-between; padding-top: 15px; margin-top: 5px; font-weight: 800; font-size: 1.1rem; color: var(--text-main); }
        .payment-footer { padding: 15px; background: var(--bg-card); display: flex; justify-content: space-between; align-items: center; }
        .pay-method-text { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 0.95rem; color: var(--text-main); }
        .collect-badge { background: linear-gradient(135deg, #00C853, #69F0AE); color: white; padding: 8px 15px; border-radius: 30px; font-size: 0.85rem; font-weight: 800; letter-spacing: 0.5px; box-shadow: 0 4px 10px rgba(0, 200, 83, 0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .online-paid-text { font-weight: 800; color: #FF5722; font-size: 0.9rem; letter-spacing: 0.5px; }
        .cancelled-badge { background: #FFEBEE; color: #D32F2F; padding: 6px 15px; border-radius: 30px; font-size: 0.85rem; font-weight: 800; border: 1px solid #FFCDD2; }
        .view-pay-btn { background: var(--input-bg); color: var(--primary); border: 1px solid var(--border-color); padding: 5px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; }
        .bengali-warning { background: #fff3e0; color: #e65100; font-size: 0.85rem; padding: 10px; border-radius: 8px; margin: 15px 15px 0 15px; border: 1px solid #ffe0b2; line-height: 1.5; }
        [data-theme="dark"] .bengali-warning { background: rgba(230, 81, 0, 0.15); color: #ffcc80; border-color: rgba(230, 81, 0, 0.3); }

        .chat-btn-circle { width: 35px; height: 35px; border-radius: 50%; background: var(--bg-card); color: var(--primary); display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary); box-shadow: 0 2px 8px rgba(255, 87, 34, 0.2); cursor: pointer; transition: 0.2s; position: relative; margin-left: 10px; }
        .chat-btn-circle:active { transform: scale(0.95); }
        .live-loc-order-btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 700; background: linear-gradient(135deg, #FF5722, #FF8A65); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(255, 87, 34, 0.3); animation: pulse-orange-btn 2s infinite; }
        @keyframes pulse-orange-btn { 0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 87, 34, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); } }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: var(--bg-card); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 90; padding-bottom: 10px; border-radius: 20px 20px 0 0; border-top: 1px solid var(--border-color); transition: transform 0.3s ease; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; color: var(--text-muted); text-decoration: none; cursor: pointer; width: 100%; padding: 10px 0; transition: 0.2s; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 5px; transition: 0.2s; color: var(--text-muted); } 
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item.active i { transform: translateY(-3px); color: var(--primary) !important; }
        .nav-icon-box { position: relative; }
        .nav-cart-badge { position: absolute; top: -5px; right: -8px; background: #F44336; color: white; font-size: 0.65rem; padding: 2px 5px; border-radius: 10px; font-weight: 700; border: 2px solid var(--bg-card); min-width: 18px; text-align: center; opacity: 0; transition: 0.2s; }
        .nav-cart-badge.show { opacity: 1; }
        @keyframes jump-cart { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-6px);} }
        .nav-item.has-items i { color: #00C853; animation: jump-cart 1.5s infinite ease-in-out; }
        .nav-item.has-items .nav-label { color: #00C853; }
        .nav-item.cart-active i { color: #FF5722 !important; animation: none !important; }
        .nav-item.cart-active { color: #FF5722 !important; }
        
        .loader-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 15px; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; text-align: center; }
        .toast { background: #333; color: white; padding: 12px 25px; border-radius: 30px; margin-bottom: 10px; font-size: 0.9rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #orders-list, #history-list { padding-bottom: 30px; }
        .mini-toast { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background: #212121; color: white; padding: 8px 20px; border-radius: 30px; font-size: 0.85rem; font-weight: 700; z-index: 6000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); opacity: 0; pointer-events: none; transition: opacity 0.1s; display:flex; align-items:center; gap:8px; }
        .mini-toast.active { opacity: 1; }
        .mini-toast.add { background: var(--success); }
        .mini-toast.remove { background: #F44336; }

        .offline-order-container { display: flex; flex-direction: column; gap: 15px; }
        .offline-contact-card { background: var(--bg-card); border-radius: 16px; padding: 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); border: 1px solid var(--border-color); text-decoration: none; color: var(--text-main); transition: 0.2s; }
        .offline-contact-card:active { transform: scale(0.98); }
        .contact-icon-box { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .contact-call { background: linear-gradient(135deg, #00C853, #69F0AE); animation: pulse-green 2s infinite; }
        .contact-whatsapp { background: #25D366; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(0, 200, 83, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); } }
        
        .contact-info-text { flex: 1; margin-left: 15px; }
        .contact-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 2px; }
        .contact-sub { font-size: 0.85rem; color: var(--text-muted); }
        .offline-desc-box { background: #fff3e0; border: 1px solid #ffe0b2; color: #e65100; padding: 15px; border-radius: 12px; font-size: 0.9rem; line-height: 1.6; margin-bottom: 10px; }
        [data-theme="dark"] .offline-desc-box { background: rgba(230, 81, 0, 0.1); border-color: rgba(230, 81, 0, 0.3); color: #ffcc80; }

        .rating-modal-content { background: var(--bg-card); width:90%; max-width:380px; border-radius:24px; padding:30px 20px; text-align:center; color:var(--text-main); box-shadow: 0 15px 40px rgba(0,0,0,0.3); position: relative; }
        .rating-chips-container { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        .rating-chip-premium { padding: 10px 18px; border-radius: 50px; background: var(--input-bg); border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; font-weight: 600; font-size: 0.9rem; }
        .rating-chip-premium.active { background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.05); box-shadow: 0 5px 15px rgba(255, 87, 34, 0.3); }
        #rating-feedback { width: 100%; border-radius: 14px; border: 1px solid var(--border-color); background: var(--input-bg); padding: 15px; font-size: 0.95rem; margin-bottom: 20px; color: var(--text-main); resize: none; transition: 0.3s; }
        #rating-feedback:focus { border-color: var(--primary); outline: none; }

        .prod-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 5500; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.3s; }
        .prod-modal-overlay.active { opacity: 1; pointer-events: auto; }
        .prod-modal-content { background: var(--bg-card); width: 100%; max-width: 600px; margin: 0 auto; border-radius: 24px 24px 0 0; padding: 0; max-height: 80vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); position: relative; box-shadow: 0 -10px 40px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
        .prod-modal-overlay.active .prod-modal-content { transform: translateY(0); }
        .modal-drag-handle-bar { width: 50px; height: 5px; background: #e0e0e0; border-radius: 10px; margin: 12px auto 5px auto; flex-shrink: 0; }
        .prod-close-abs { position: absolute; top: 15px; right: 15px; background: #eee; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.9rem; color: var(--primary); z-index: 10; }
        [data-theme="dark"] .prod-close-abs { background: #333; }
        .prod-modal-img { width: 100%; height: 220px; object-fit: cover; border-radius: 16px; margin-top: 5px; }
        .prod-modal-body { padding: 20px; overflow-y: auto; }
        .prod-modal-title { font-size: 1.4rem; font-weight: 700; color: var(--text-main); margin-bottom: 5px; line-height: 1.3; }
        .prod-modal-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 20px; }
        .prod-modal-footer { padding: 15px 20px; background: var(--bg-card); border-top: 1px solid var(--border-color); display: flex; justify-content: center; padding-bottom: 25px; }
        .qty-premium-box { display: flex; align-items: center; justify-content: space-between; background: var(--input-bg); border-radius: 50px; padding: 6px 8px; width: 100%; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border-color); gap: 10px; }
        .qty-btn-premium { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--bg-card); color: var(--text-main); font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.2s; }
        .qty-btn-premium.add { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(255,87,34,0.3); }
        .qty-btn-premium:active { transform: scale(0.9); }
        .qty-val-premium { font-size: 1.4rem; font-weight: 800; color: var(--text-main); min-width: 30px; text-align: center; }
        .cart-qty-control { display: flex; align-items: center; gap: 10px; background: var(--input-bg); padding: 4px; border-radius: 20px; border: 1px solid var(--border-color); }
        .qty-mini-btn { width: 28px; height: 28px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; background: var(--bg-card); color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .qty-mini-btn.plus { background: var(--primary); color: white; }

        .chat-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 7000; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: 0.3s; }
        .chat-modal-content { background: var(--bg-card); flex: 1; display: flex; flex-direction: column; margin-top: 50px; border-radius: 24px 24px 0 0; overflow: hidden; position: relative; }
        .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); z-index: 2; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .chat-rider-info { display: flex; flex-direction: column; }
        .chat-rider-name { font-weight: 700; font-size: 1.1rem; }
        .chat-status { font-size: 0.75rem; color: var(--primary); font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .typing-dots span { width: 4px; height: 4px; background: var(--primary); border-radius: 50%; display: inline-block; animation: typing 1.4s infinite; margin-right: 2px; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .chat-body { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: var(--input-bg); }
        .msg-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-bubble.sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .msg-bubble.received { align-self: flex-start; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); border-bottom-left-radius: 4px; }
        .msg-meta { font-size: 0.65rem; display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 4px; opacity: 0.8; }
        .seen-icon { font-size: 0.7rem; }
        .seen-icon.read { color: #81D4FA; }
        .chat-footer { padding: 15px; background: var(--bg-card); border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        .chat-input { flex: 1; background: var(--input-bg); border: 1px solid var(--border-color); padding: 12px 15px; border-radius: 25px; outline: none; color: var(--text-main); transition: 0.3s; }
        .chat-input:focus { border-color: var(--primary); }
        .chat-send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; border: none; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .chat-send-btn:active { transform: scale(0.9); }
        .chat-close-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-main); }
        [data-theme="dark"] .chat-close-btn { background: rgba(255,255,255,0.1); }


        .confirm-order-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 7000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .confirm-order-overlay.active { opacity: 1; pointer-events: auto; }
        .confirm-card { background: var(--bg-card); width: 90%; max-width: 350px; border-radius: 24px; padding: 25px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--border-color); animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .confirm-icon { font-size: 3.5rem; margin-bottom: 15px; }
        .confirm-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 10px; color: var(--text-main); }
        .confirm-msg { font-size: 0.95rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 25px; }
        .btn-confirm-yes { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-confirm-yes:active { transform: scale(0.98); }
        
        @keyframes popUp { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 87, 34, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); } }
        

        .auth-container { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; background: var(--bg-card); padding: 30px; position: fixed; top: 0; left: 0; width: 100%; z-index: 200; overflow-y: auto; }
        .auth-logo-box { text-align: center; margin-bottom: 30px; }
        .auth-logo-box img { width: 100px; height: 100px; object-fit: contain; margin-bottom: 10px; }
        .auth-title { font-size: 2rem; font-weight: 800; color: var(--text-main); margin-bottom: 5px; }
        .auth-subtitle { color: var(--text-muted); margin-bottom: 30px; }
        .auth-toggle-link { text-align: center; margin-top: 20px; font-size: 0.9rem; color: var(--text-muted); }
        .auth-toggle-link span { color: var(--primary); font-weight: 700; cursor: pointer; }

    </style>
</head>
<body>

    <div id="toast-container"></div>
    <!-- MINI TOAST FOR ADD/REMOVE -->
    <div id="mini-toast" class="mini-toast"></div>

    <div id="global-loader" class="loader-overlay hidden"><div class="spinner"></div><p style="font-weight:600; color:white">Please wait...</p></div>

    <!-- CUSTOM GLOBAL ALERT/CONFIRM MODAL -->
    <div id="custom-modal" class="custom-modal-overlay">
        <div class="custom-modal-card">
            <div id="cm-icon" class="cm-icon"><i class="fas fa-info-circle"></i></div>
            <div id="cm-title" class="cm-title">Notice</div>
            <div id="cm-desc" class="cm-desc"></div>
            <button id="cm-btn" class="cm-btn" onclick="closeCustomModal()">OK</button>
        </div>
    </div>

    <!-- GLOBAL CHAT NOTIFICATION BANNER (PREMIUM DROPDOWN) -->
    <div id="global-chat-notification" class="chat-notification-banner" onclick="handleChatNotificationClick()">
        <div class="chat-notif-content">
            <div class="chat-notif-icon"><i class="fas fa-comment-dots"></i></div>
            <div class="chat-notif-text">
                <div class="chat-notif-title">New Message</div>
                <div class="chat-notif-msg" id="gcn-message">From Rider</div>
            </div>
        </div>
        <div class="chat-notif-actions">
            <span id="gcn-badge" class="chat-badge-stack hidden">+1</span>
            <div class="btn-sm btn-primary" style="padding:6px 14px; font-size:0.75rem;">Reply</div>
            <i class="fas fa-times chat-close-notif" onclick="closeChatNotification(event)"></i>
        </div>
    </div>
    
    <!-- SUCCESS ANIMATION OVERLAY -->
    <div id="success-overlay">
        <div class="checkmark-circle"><i class="fas fa-check checkmark-icon"></i></div>
        <h2 style="font-weight:700; margin-bottom:5px;">Order Placed!</h2>
        <p style="opacity:0.8">Redirecting to orders...</p>
    </div>

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="splash-logo-container">
            <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/FOOD%20APP%2FAddText_02-03-06.21.30.png?alt=media&token=64b1afb2-8d80-4b57-a1e8-d582758a2d67" class="splash-logo-img" alt="Logo">
        </div>
        <div class="splash-title">Money Food</div>
        <div class="splash-tagline">Premium Taste, Premium Speed</div>
    </div>

    <!-- === AUTH SCREENS (SEPARATE) === -->
    
    <!-- LOGIN SCREEN -->
    <div id="page-login" class="auth-container hidden">
        <div class="auth-logo-box">
            <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/FOOD%20APP%2FAddText_02-04-11.55.29.png?alt=media&token=12ebe32e-7475-4005-b153-ee5664b65f0c">
            <h2 class="auth-title">Welcome Back</h2>
            <p class="auth-subtitle">Login to satisfy your hunger</p>
        </div>
        <input type="email" id="login-email" class="form-control" placeholder="Email Address">
        <input type="password" id="login-password" class="form-control" placeholder="Password">
        <button class="btn btn-primary" onclick="handleLogin()">Login</button>
        <div class="auth-toggle-link">
            Don't have an account? <span onclick="showAuthPage('register')">Sign Up</span>
        </div>
    </div>

    <!-- REGISTER SCREEN -->
    <div id="page-register" class="auth-container hidden">
        <div class="auth-logo-box">
            <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/FOOD%20APP%2FAddText_02-04-11.55.29.png?alt=media&token=12ebe32e-7475-4005-b153-ee5664b65f0c">
            <h2 class="auth-title">Create Account</h2>
            <p class="auth-subtitle">Join us for premium food delivery</p>
        </div>
        <input type="text" id="reg-name" class="form-control" placeholder="Full Name">
        <input type="email" id="reg-email" class="form-control" placeholder="Email Address">
        <input type="password" id="reg-password" class="form-control" placeholder="Password">
        <button class="btn btn-primary" onclick="handleSignup()">Sign Up</button>
        <div class="auth-toggle-link">
            Already have an account? <span onclick="showAuthPage('login')">Login</span>
        </div>
    </div>


    <!-- ORDER CONFIRMATION MODAL -->
    <div id="confirm-order-modal" class="confirm-order-overlay">
        <div class="confirm-card">
            <div class="confirm-icon"></div>
            <div class="confirm-title"> </div>
            <div class="confirm-msg">
                                            ,    
            </div>
            <button id="btn-confirm-final" class="btn-confirm-yes disabled" onclick="confirmAndPlaceOrder()">  (5s)</button>
        </div>
    </div>

    <!-- CHAT MODAL -->
    <div id="chat-modal" class="chat-modal-overlay">
        <div class="chat-modal-content">
            <div class="chat-header">
                <div class="chat-rider-info">
                    <div class="chat-rider-name" id="chat-rider-name">Rider</div>
                    <div class="chat-status" id="chat-status-text"></div>
                </div>
                <div class="chat-close-btn" onclick="closeChat()"><i class="fas fa-times"></i></div>
            </div>
            <div class="chat-body" id="chat-messages"></div>
            <div class="chat-footer">
                <input type="text" id="chat-input-field" class="chat-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
                <button class="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- RATING MODAL -->
    <div id="rating-modal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:2000; display:flex; justify-content:center; align-items:center; backdrop-filter: blur(5px);">
        <div class="rating-modal-content">
            <h3 style="font-size:1.5rem;font-weight:700;margin-bottom:20px;">Rate Your Meal</h3>
            <div class="rating-chips-container">
                <div class="rating-chip-premium" onclick="selectRating(this)"> Delicious</div>
                <div class="rating-chip-premium" onclick="selectRating(this)"> Fast Delivery</div>
                <div class="rating-chip-premium" onclick="selectRating(this)"> Good Price</div>
                <div class="rating-chip-premium" onclick="selectRating(this)"> Bad Taste</div>
                <div class="rating-chip-premium" onclick="selectRating(this)"> Slow</div>
            </div>
            <textarea id="rating-feedback" class="hidden" rows="3" placeholder="Write your feedback for the admin..."></textarea>
            <button class="btn btn-primary" onclick="submitRating()" style="margin-bottom:10px;">Submit Feedback</button>
            <button class="btn btn-outline" style="border:none; color:var(--text-muted)" onclick="closeRating()">Skip for now</button>
        </div>
    </div>

    <!-- PRODUCT DETAILS MODAL (BOTTOM SHEET) -->
    <div id="product-details-modal" class="prod-modal-overlay" onclick="closeProductModal()">
        <div class="prod-modal-content" onclick="event.stopPropagation()" id="prod-modal-inner">
            <div class="modal-drag-handle-bar" id="prod-drag-handle"></div>
            <div class="prod-close-abs" onclick="closeProductModal()"><i class="fas fa-times"></i></div>
            <div class="prod-modal-body">
                <img id="pm-img" class="prod-modal-img" src="">
                <div style="margin-top:15px;">
                    <div class="prod-modal-title" id="pm-name"></div>
                    <div style="font-size:1.3rem; font-weight:700; color:var(--primary); margin-bottom:10px;" id="pm-price"></div>
                    <div class="prod-modal-desc" id="pm-desc"></div>
                </div>
            </div>
            <div class="prod-modal-footer">
                <div class="qty-premium-box">
                    <button class="qty-btn-premium" onclick="adjustModalQty(-1)"><i class="fas fa-minus"></i></button>
                    <span class="qty-val-premium" id="pm-qty">0</span>
                    <button class="qty-btn-premium add" onclick="adjustModalQty(1)"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: CART REVIEW MODAL (Bottom sheet with drag to dismiss) -->
    <div id="cart-review-modal" class="prod-modal-overlay">
        <div class="prod-modal-content" id="cart-review-content">
            <div class="modal-drag-handle-bar"></div>
            <div class="prod-modal-body" style="padding-top: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px 0;" id="cart-review-header">
                    <h3 id="cr-restaurant-name" style="font-size: 1.3rem; font-weight: 700; color: var(--text-main);">My Cart</h3>
                    <div class="prod-close-abs" style="position: static; color: var(--primary);" onclick="closeCartReview()"><i class="fas fa-times"></i></div>
                </div>
                <div id="cr-items-list" style="max-height: 50vh; overflow-y: auto;">
                    <!-- Cart items will be injected here -->
                </div>
            </div>
            <div class="prod-modal-footer" style="flex-direction: column; gap: 15px;">
                <div style="display: flex; justify-content: space-between; width: 100%; font-size: 1.2rem; font-weight: 800; color: var(--text-main);">
                    <span>Total</span>
                    <span id="cr-total"> 0</span>
                </div>
                <button class="btn btn-primary" onclick="proceedToFinalCheckout()">Proceed to Checkout</button>
            </div>
        </div>
    </div>


    <!-- PAYMENT DETAILS MODAL -->
    <div id="pay-details-modal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:2000; display:flex; justify-content:center; align-items:center;">
        <div style="background:var(--bg-card); padding:25px; border-radius:16px; width:90%; max-width:350px; color:var(--text-main);">
            <h4 style="margin-bottom:15px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">Payment Details</h4>
            <p><b>Method:</b> <span id="md-method"></span></p>
            <p><b>Sender:</b> <span id="md-sender"></span></p>
            <p><b>Trx ID:</b> <span id="md-trx"></span></p>
            <p><b>Amount:</b> <span id="md-amount" style="color:var(--primary); font-weight:bold;"></span></p>
            <button class="btn btn-primary btn-sm" style="margin-top:15px" onclick="document.getElementById('pay-details-modal').classList.add('hidden')">Close</button>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-layout" class="hidden">
        <header>
            <div class="app-logo">
                <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/FOOD%20APP%2FAddText_02-04-11.55.29.png?alt=media&token=12ebe32e-7475-4005-b153-ee5664b65f0c" alt="Logo">
                Money Food
            </div>
            <div class="search-icon-wrapper" id="header-search-icon" onclick="toggleSearchOverlay()">
                <i class="fas fa-search"></i>
            </div>
        </header>

        <div id="header-search-overlay" class="search-overlay">
            <input type="text" class="header-search-input" id="global-search-input" placeholder="What are you craving?" oninput="filterProductsSearch(this.value)">
            <div class="search-suggestions-list" id="search-results-list"></div>
        </div>
        
        <main>
            <!-- === HOME PAGE (NOW RESTAURANTS) === -->
            <div id="page-home" class="page-section">
                <div class="container">
                    <div class="loyalty-card">
                        <div class="loyalty-header">
                            <div>
                                <div class="loyalty-title">Premium Rewards</div>
                                <div class="loyalty-desc">Order 6 times, get the 7th delivery <b>FREE!</b></div>
                            </div>
                        </div>
                        <i class="fas fa-gift loyalty-icon"></i>
                        <div class="track-container" id="loyalty-track-container"></div>
                        <div style="font-size:0.75rem; color:rgba(255,255,255,0.7); margin-top:15px; text-align:center;">Complete the cycle to unlock free delivery.</div>
                    </div>
                
                    <div class="page-header" style="padding-top:0;"><h3>Restaurants</h3></div>
                    <div class="restaurant-grid" id="restaurant-grid"></div>
                </div>
            </div>

            <!-- === RESTAURANT MENU PAGE (NEW) === -->
            <div id="page-restaurant-menu" class="page-section hidden">
                <div class="menu-hero-section" id="menu-hero-section">
                    <div class="menu-hero-bg" id="menu-hero-bg"></div>
                    <div class="menu-hero-overlay"></div>
                    <div class="menu-hero-nav">
                        <div class="menu-hero-btn" onclick="showPage('home')"><i class="fas fa-arrow-left"></i></div>
                        <div class="menu-hero-btn menu-cart-icon" onclick="openCartReviewForCurrentRestaurant()">
                            <i class="fas fa-shopping-bag"></i>
                            <div class="menu-cart-badge" id="menu-cart-badge">0</div>
                        </div>
                    </div>
                    <div class="menu-hero-content">
                        <h1 class="menu-hero-title" id="menu-hero-title"></h1>
                        <p class="menu-hero-desc" id="menu-hero-desc"></p>
                    </div>
                </div>

                <div class="menu-product-container">
                    <div class="sticky-filter-bar">
                        <div class="filters" id="category-filters-container"></div>
                    </div>
                    <div class="product-grid" id="product-list"></div>
                </div>
                <input type="hidden" id="active-modal-pid">
            </div>
            
            <!-- === GLOBAL CART PAGE (NEW FULL SCREEN) === -->
            <div id="page-global-cart" class="page-section hidden">
                <div class="container" id="global-cart-items">
                    <!-- Dynamic content will be injected here -->
                </div>
            </div>


            <!-- === CHECKOUT PAGE (NOW A FULL PAGE) === -->
            <div id="page-checkout" class="page-section hidden">
                <div class="container">
                    <div class="page-header"><h3>Confirm Order</h3><button class="btn-sm btn-outline" onclick="closeCheckout()">Back</button></div>
                    
                    <div class="checkout-box">
                        <div class="section-title"><i class="fas fa-shopping-basket"></i> Order Summary</div>
                        <div id="checkout-items-list" style="max-height:180px; overflow-y:auto; padding-right:5px;"></div>
                    </div>

                    <div class="checkout-box">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <div class="section-title" style="margin:0"><i class="fas fa-map-marker-alt"></i> Delivery Details</div>
                            <span style="font-size:0.8rem; color:var(--primary); cursor:pointer; font-weight:600" onclick="prepareAddressEdit()">CHANGE</span>
                        </div>
                        <div id="co-address-display" style="font-size:0.9rem; color:var(--text-muted); line-height:1.5; margin-bottom:15px;"></div>
                        
                        <div class="premium-location-box" onclick="getLocation()" id="loc-box">
                            <div class="loc-title" id="loc-title-text"><i class="fas fa-map-marker-alt"></i> Share Live Location</div>
                            <div class="loc-subtitle" id="loc-status-text">Tap to enable map</div>
                        </div>
                        <div class="loc-bengali-note">
                            <i class="fas fa-info-circle" style="color:#2196F3"></i>              
                        </div>
                        <div id="loc-map-preview" class="hidden"></div>
                        <div id="loc-address-text" class="map-address-display hidden"></div>

                        <div style="margin-top:10px;">
                            <label style="font-size:0.85rem; color:var(--text-muted); display:block; margin-bottom:5px;">               </label>
                            <input type="text" class="form-control" id="location-link-input" placeholder="Google Maps Link here..." style="font-size:0.9rem;">
                        </div>

                        <textarea class="rider-note-box" id="rider-note" rows="2" placeholder="rider ke kichu bolte chaile ekhane likhun..."></textarea>
                    </div>
                    
                    <div class="checkout-box">
                        <div class="section-title"><i class="fas fa-shipping-fast"></i> Delivery Priority</div>
                        <div class="delivery-options-grid">
                            <div class="del-opt-card active" onclick="setDeliveryPriority('normal', this)" id="opt-normal">
                                <div class="del-opt-title">Normal</div>
                                <div class="del-opt-price" id="fee-normal">35 </div>
                                <div class="del-opt-badge">Standard</div>
                            </div>
                            <div class="del-opt-card" onclick="setDeliveryPriority('fast', this)" id="opt-fast">
                                <div class="del-opt-title"> Fast</div>
                                <div class="del-opt-price" id="fee-fast">55 </div>
                                <div class="del-opt-badge">Emergency (+20)</div>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-box">
                        <div class="section-title"><i class="fas fa-heart"></i> Rider Tip</div>
                        <div class="tip-grid">
                            <div class="tip-card selected" onclick="setTip(0, this)"><span class="tip-emoji"></span><span class="tip-amount">No</span></div>
                            <div class="tip-card" onclick="setTip(10, this)"><span class="tip-emoji"></span><span class="tip-amount">10</span></div>
                            <div class="tip-card" onclick="setTip(20, this)"><span class="tip-emoji"></span><span class="tip-amount">20</span></div>
                            <div class="tip-card" onclick="setTip(50, this)"><span class="tip-emoji"></span><span class="tip-amount">50</span></div>
                        </div>
                        <input type="number" id="tip-manual" class="form-control" placeholder="    " style="margin-bottom:0; font-size:0.9rem; padding:10px;" oninput="setTip(this.value, null, true)">
                    </div>

                    <div class="checkout-box">
                        <div class="section-title"><i class="fas fa-wallet"></i> Payment Method</div>
                        <div id="payment-methods-container"></div>
                        <div id="online-payment-warning" class="bengali-warning hidden"></div>
                    </div>

                    <div class="checkout-box" style="border:none; box-shadow:none; background:transparent; padding:0;">
                        <div style="background:var(--bg-card); padding:20px; border-radius:16px; box-shadow:var(--shadow);">
                            <div class="section-title"><i class="fas fa-file-invoice-dollar"></i> Bill Details</div>
                            <div class="bill-row"><span>Subtotal</span><span id="co-subtotal">0 </span></div>
                            <div class="bill-row"><span>Platform Fee</span><span>Free</span></div>
                            <div class="bill-row"><span>Delivery Charge</span><span id="co-delivery">0 </span></div>
                            <div class="bill-row"><span>Rider Tip</span><span id="co-tip">0 </span></div>
                            <div class="bill-row" id="row-cashout"><span>Cashout Charge (Online)</span><span id="co-cashout">0 </span></div>
                            <div class="bill-row grand-total"><span>To Pay</span><span id="co-grand">0 </span></div>
                        </div>
                    </div>

                    <div class="savings-card hidden" id="price-compare-box">
                        <img id="comp-banner-img" src="" class="savings-banner">
                        <div class="savings-content">
                            <div class="savings-title">Smart Savings</div>
                            <div class="compare-grid">
                                <div class="compare-item">
                                    <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/FOOD%20APP%2FAddText_02-04-11.55.29.png?alt=media&token=12ebe32e-7475-4005-b153-ee5664b65f0c" class="compare-logo" style="border-color:#00C853">
                                    <div class="compare-name">Money Food</div>
                                    <div class="compare-price price-mf" id="cmp-mf-price"> 0</div>
                                </div>
                                <div class="compare-grid::after"></div>
                                <div class="compare-item">
                                    <img id="comp-logo-img" src="" class="compare-logo" style="border-color:#D32F2F">
                                    <div class="compare-name">Other Company</div>
                                    <div class="compare-price price-other" id="cmp-other-price"> 0</div>
                                </div>
                            </div>
                            <div class="you-save-pill" id="cmp-save-amt">YOU SAVE:  0</div>
                        </div>
                    </div>

                    <div class="swipe-container" id="swipe-btn">
                        <div class="swipe-bg-active" id="swipe-bg"></div>
                        <div class="swipe-text">Slide to Confirm <i class="fas fa-arrow-right" style="margin-left:8px;"></i></div>
                        <div class="swipe-handle" id="swipe-handle"><i class="fas fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>

            <div id="page-orders" class="page-section hidden"><div class="container"><div class="page-header"><h3>Active Orders</h3></div><div id="orders-list"></div></div></div>
            <div id="page-history" class="page-section hidden"><div class="container"><div class="page-header"><h3>Order History</h3><button class="btn-sm btn-outline" onclick="showPage(previousPage)">Back</button></div><div id="history-list"></div></div></div>
            
            <div id="page-profile" class="page-section hidden">
                <div class="container">
                    <div class="profile-premium-card" onclick="showPage('edit-profile')">
                        <img id="profile-avatar-img" class="profile-avatar-premium" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png">
                        <div class="profile-info-premium">
                            <div id="profile-display-name" class="profile-name-premium">Guest</div>
                            <div id="profile-display-email" class="profile-email-premium"></div>
                        </div>
                        <i class="fas fa-pen profile-edit-badge"></i>
                    </div>
                    
                    <div class="savings-report-card">
                        <div class="savings-header-wrapper">
                            <div class="savings-header">Lifetime Savings</div>
                            <div class="savings-info-icon" onclick="toggleSavingsPopup(true)">i</div>
                        </div>
                        <div class="savings-grid-3">
                            <div class="sav-box">
                                <span class="sav-val" id="rep-competitor" style="color:#aaa">0 </span>
                                <span class="sav-lbl">O.C charged</span>
                            </div>
                            <div class="sav-box">
                                <span class="sav-val" id="rep-spent" style="color:#aaa">0 </span>
                                <span class="sav-lbl">MF charged</span>
                            </div>
                            <div class="sav-box">
                                <span class="sav-val" id="rep-del-saved" style="color:#00C853">0 </span>
                                <span class="sav-lbl">Free Delivery</span>
                            </div>
                        </div>
                        <div class="total-savings-banner">
                            Total Saved: <span id="rep-saved">0 </span>
                        </div>
                    </div>

                    <div id="saved-address-card" class="address-display-card hidden">
                        <div class="address-info-left">
                            <div class="address-icon-box"><i class="fas fa-map-marked-alt"></i></div>
                            <div class="address-text-content">
                                <div class="addr-area-title" id="card-addr-area">Loading...</div>
                                <div class="addr-detail-text" id="card-addr-details">...</div>
                            </div>
                        </div>
                        <button class="address-edit-btn" onclick="prepareAddressEdit()">
                            <i class="fas fa-pencil-alt"></i> Edit
                        </button>
                    </div>
                    <div id="add-address-btn-wrapper" class="hidden" style="margin-bottom:20px;">
                        <button class="btn btn-outline" onclick="showPage('address')"><i class="fas fa-plus"></i> Add Delivery Address</button>
                    </div>

                    <div class="profile-menu-item" onclick="showPage('offline')">
                        <i class="fas fa-phone-volume"></i> Offline Order
                    </div>

                    <div class="profile-menu-item">
                        <div class="theme-toggle-wrapper">
                            <span style="display:flex; align-items:center; gap:15px"><i class="fas fa-moon"></i> Dark Mode</span>
                            <label class="theme-switch"><input type="checkbox" id="theme-toggle" onchange="toggleTheme()"><span class="slider"></span></label>
                        </div>
                    </div>

                    <div class="profile-menu-item" onclick="showPage('orders')"><i class="fas fa-box-open"></i> Active Orders</div>
                    <div class="profile-menu-item" onclick="showPage('history')"><i class="fas fa-history"></i> Order History</div>
                    <div class="profile-menu-item" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</div>
                </div>
            </div>

            <div id="page-offline" class="page-section hidden">
                <div class="container">
                    <div class="page-header"><h3>Offline Order</h3><button class="btn-sm btn-outline" onclick="showPage(previousPage)">Back</button></div>
                    
                    <div class="offline-desc-box">
                        <i class="fas fa-info-circle"></i>        / -    
                    </div>

                    <div class="offline-order-container">
                        <a href="tel:01601630967" class="offline-contact-card">
                            <div class="contact-icon-box contact-call">
                                <i class="fas fa-phone-alt"></i>
                            </div>
                            <div class="contact-info-text">
                                <div class="contact-title">Call Now</div>
                                <div class="contact-sub">01601630967 (Help Line)</div>
                            </div>
                            <i class="fas fa-chevron-right" style="color:var(--text-muted)"></i>
                        </a>

                        <a href="https://wa.me/8801601630967" class="offline-contact-card" target="_blank">
                            <div class="contact-icon-box contact-whatsapp">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <div class="contact-info-text">
                                <div class="contact-title">WhatsApp Message</div>
                                <div class="contact-sub">Chat to place order</div>
                            </div>
                            <i class="fas fa-chevron-right" style="color:var(--text-muted)"></i>
                        </a>
                    </div>

                    <div style="margin-top:20px; text-align:center; color:var(--text-muted); font-size:0.9rem;">
                        <i class="far fa-clock"></i> Service time: <span style="font-weight:700; color:var(--text-main)" id="service-hours-display"></span>
                    </div>
                </div>
            </div>

            <div id="page-edit-profile" class="page-section hidden">
                <div class="container">
                    <div class="page-header"><h3>Edit Profile</h3><button class="btn-sm btn-outline" onclick="showPage(previousPage)">Back</button></div>
                    
                    <div class="edit-profile-card">
                        <div class="edit-prof-header">
                            <img id="edit-avatar-preview" class="edit-prof-avatar" src="" onclick="document.getElementById('profile-pic-input').click()">
                            <div style="font-size:0.8rem; color:var(--primary); font-weight:600; cursor:pointer;" onclick="document.getElementById('profile-pic-input').click()">Tap to change photo</div>
                            <input type="file" id="profile-pic-input" class="custom-file-input hidden" accept="image/*" onchange="previewAvatar(event)">
                        </div>

                        <div class="edit-input-group">
                            <label class="edit-label">Full Name</label>
                            <input type="text" id="prof-name" class="edit-input" placeholder="Your Name">
                        </div>
                        
                        <div class="edit-input-group">
                            <label class="edit-label">Phone Number</label>
                            <input type="tel" id="prof-phone" class="edit-input" placeholder="017...">
                        </div>

                        <button class="btn btn-primary" onclick="saveProfile()" style="margin-top:10px;">Save Changes</button>
                    </div>
                </div>
            </div>

            <div id="page-address" class="page-section hidden">
                 <div class="container">
                    <div class="page-header"><h3>Delivery Address</h3><button class="btn-sm btn-outline" onclick="goBackFromAddress()">Back</button></div>
                    
                    <div class="addr-glass-card">
                        <button class="live-loc-btn-lg" onclick="detectAddressLocation()">
                            <div class="loc-pulse"><i class="fas fa-map-marker-alt"></i></div>
                            <div>Detect Live Location</div>
                        </button>
                        <p style="font-size:0.8rem; color:var(--text-muted); text-align:center; margin-bottom:15px;">       </p>
                        
                        <div id="addr-map-frame" class="detected-map-box"></div>
                        <div id="addr-detected-text" class="detected-address-text"></div>

                        <div style="margin: 15px 0; display:flex; align-items:center; gap:10px; opacity:0.6;">
                            <div style="height:1px; background:#ccc; flex:1"></div>
                            <span style="font-size:0.8rem;">OR FILL MANUALLY</span>
                            <div style="height:1px; background:#ccc; flex:1"></div>
                        </div>

                        <label style="font-weight:600; color:var(--text-main); margin-bottom:5px; display:block;">Select Area</label>
                        <select id="addr-area" class="form-control" onchange="toggleAddressFields()">
                            <option value="">Choose Area...</option>
                            <option value="Mirpur 2">Mirpur 2</option>
                            <option value="Mirpur 6">Mirpur 6</option>
                            <option value="Mirpur 7">Mirpur 7</option>
                            <option value="Mirpur 11">Mirpur 11</option>
                            <option value="Mirpur 12">Mirpur 12</option>
                            <option value="DOHS">DOHS</option>
                        </select>
                        
                        <div id="dohs-fields" class="hidden">
                            <input type="text" id="addr-dohs-avenue" class="form-control" placeholder="Avenue No">
                            <input type="text" id="addr-dohs-road" class="form-control" placeholder="Road No">
                            <input type="text" id="addr-dohs-house" class="form-control" placeholder="House No">
                        </div>
                        <div id="other-area-field" class="hidden">
                            <textarea id="addr-details" class="form-control" rows="2" placeholder="House no, Floor, Landmark..."></textarea>
                        </div>
                        
                        <label style="font-weight:600; color:var(--text-main); margin-top:10px; display:block;">Contact Number</label>
                        <div style="display:flex; gap:15px; margin-bottom:10px; color:var(--text-main); margin-top:5px;">
                            <label><input type="radio" name="contactType" value="Running" checked> Running</label>
                            <label><input type="radio" name="contactType" value="WhatsApp"> WhatsApp</label>
                        </div>
                        <input type="tel" id="addr-contact-number" class="form-control" placeholder="017...">
                    </div>
                    
                    <div class="addr-glass-card">
                        <label style="font-weight:600; color:var(--text-main); margin-bottom:10px; display:block;">House/Gate Image (Optional)</label>
                        <div class="file-upload-wrapper" style="margin-bottom:15px; height:100px;">
                            <i class="fas fa-camera" style="font-size:1.5rem; color:var(--primary)"></i>
                            <p style="font-size:0.8rem">Tap to upload photos</p>
                            <input type="file" id="house-image-input" class="custom-file-input" accept="image/*" multiple onchange="handleAddressImages(event)">
                        </div>
                        <div class="multi-img-grid" id="addr-img-preview-grid"></div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveAddress()" style="margin-bottom:30px;">Save Address & Continue</button>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <a class="nav-item active" onclick="showPage('home')" id="nav-home"><i class="fas fa-home"></i>Home</a>
            <a class="nav-item" onclick="showPage('global-cart')" id="nav-btn-cart">
                <div class="nav-icon-box">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="nav-cart-badge" id="nav-badge-count">0</span>
                </div>
                <span class="nav-label">Cart</span>
            </a>
            <a class="nav-item" onclick="showPage('orders')" id="nav-orders"><i class="fas fa-shopping-bag"></i>Orders</a>
            <a class="nav-item" onclick="showPage('profile')" id="nav-profile"><i class="fas fa-user"></i>Profile</a>
        </nav>
    </div>

    <div id="savings-popup" class="savings-popup-overlay">
        <div class="savings-popup-content">
            <h3 class="popup-title">  </h3>
            <div class="comparison-row">
                <span>   :</span>
                <span class="other-company-price" id="popup-competitor-price"> 0</span>
            </div>
            <div class="comparison-row">
                <span>Money Food-  :</span>
                <span class="money-food-price" id="popup-spent-price"> 0</span>
            </div>
            <div class="total-saved-popup">
                  : <span id="popup-saved-price"> 0</span>
            </div>
            <p class="company-slogan">
                                  ,            
            </p>
            <button class="popup-close-btn" onclick="toggleSavingsPopup(false)"> </button>
        </div>
    </div>


    <script type="module">
        /* =========================================
           SECTION: FIREBASE CONFIG
           ========================================= */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, update, remove, serverTimestamp, get, onChildAdded, onChildChanged, off } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC-QeK211wkCYaO8hjJS89P0lldCTHMp38", authDomain: "topup-52074.firebaseapp.com",
            databaseURL: "https://topup-52074-default-rtdb.firebaseio.com", projectId: "topup-52074", storageBucket: "topup-52074.appspot.com",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app), db = getDatabase(app), storage = getStorage(app);

        /* =========================================
           SECTION: STATE MANAGEMENT
           ========================================= */
        let currentUser, currentUserProfile={}, cart=[], products=[], categories=[], restaurants = [], addressImages=[], appSettings = {
            paymentMethods: { cod: true, bkash: true, nagad: true, rocket: true }, compareBannerUrl: "", competitorLogo: "",
            paymentNumbers: { bkash: "01647712206", nagad: "01647712206" },
            serviceStartTime: "07:00", serviceEndTime: "24:00"
        }, riderTip=0, selectedPayment=null, locationData={enabled:false}, currentOrderIdForRating = null, cashOutFee = 0;
        
        let deliveryPriority = 'normal'; 
        let userTotalDeliveredOrders = 0;
        let isOrderProcessing = false; 
        let activeChatOrderId = null;
        let activeChatRiderId = null;
        let toastTimeout; 

        let activeRestaurantId = null; 
        let checkoutRestaurantId = null;
        
        let currentPage = 'home';
        let previousPage = 'home';
        
        let unreadChatQueue = []; 
        let dismissedMessages = new Set(); 
        let notificationsAllowed = false; 

        try { cart = JSON.parse(localStorage.getItem('cart')) || []; } catch(e) { cart = []; }

        /* =========================================
           SECTION: UTILS & THEME
           ========================================= */
        window.toggleTheme = () => { 
            const isDark = document.getElementById('theme-toggle').checked; 
            const theme = isDark ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme); 
            localStorage.setItem('theme', theme); 
            document.getElementById('theme-color-meta').content = isDark ? '#151515' : '#FFFFFF';
        };

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-toggle').checked = (savedTheme === 'dark');
            document.getElementById('theme-color-meta').content = savedTheme === 'dark' ? '#151515' : '#FFFFFF';
        }
        applySavedTheme();

        window.showToast=(m,t='success')=>{const c=document.getElementById('toast-container'),el=document.createElement('div');el.className='toast';el.style.background=t==='error'?'var(--danger)':'#333';el.innerHTML=m;c.appendChild(el);setTimeout(()=>el.remove(),3000);};
        window.showCustomAlert = (msg, title="Notice") => { const m = document.getElementById('custom-modal'); document.getElementById('cm-title').innerText = title; document.getElementById('cm-desc').innerText = msg; m.classList.add('active'); };
        window.closeCustomModal = () => { document.getElementById('custom-modal').classList.remove('active'); };
        window.alert = window.showCustomAlert;
        const toggleLoader=s=>document.getElementById('global-loader').classList.toggle('hidden',!s);
        const formatPrice=p=>` ${p}`;
        
        // --- Navigation Logic ---
        function setPage(id) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            const pageEl = document.getElementById(`page-${id}`);
            if (pageEl) pageEl.classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            const navId = id === 'global-cart' ? 'btn-cart' : id;
            if(document.getElementById(`nav-${navId}`)) document.getElementById(`nav-${navId}`).classList.add('active');
            
            document.body.classList.toggle('hide-nav', id === 'restaurant-menu');

            window.scrollTo(0, 0);
        }

        window.showPage = (id, context = null) => {
            if (id === currentPage && id !== 'restaurant-menu') return;

            previousPage = currentPage;
            currentPage = id;
            
            const searchIcon = document.getElementById('header-search-icon');
            if (searchIcon) {
                searchIcon.style.display = (id === 'home') ? 'flex' : 'none';
            }

            if (id === 'restaurant-menu') {
                showRestaurantMenu(context); 
                return;
            }
            
            setPage(id);

            if (id === 'global-cart') renderGlobalCartPage();
        };

        window.goBackFromAddress = () => showPage(previousPage);
        
        window.showAuthPage = (page) => { document.getElementById('page-login').classList.add('hidden'); document.getElementById('page-register').classList.add('hidden'); document.getElementById(`page-${page}`).classList.remove('hidden'); };
        window.showMiniToast = (msg, type = "default") => { const t = document.getElementById('mini-toast'); t.classList.remove('active'); clearTimeout(toastTimeout); setTimeout(() => { t.innerHTML = `<span>${msg}</span>`; if(type === 'add') t.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`; if(type === 'remove') t.innerHTML = `<i class="fas fa-trash"></i> ${msg}`; t.className = "mini-toast"; if(type === 'add') t.classList.add('add'); if(type === 'remove') t.classList.add('remove'); t.classList.add('active'); toastTimeout = setTimeout(() => { t.classList.remove('active'); }, 1000); }, 50); };
        window.addEventListener('load', () => { setTimeout(() => { document.getElementById('splash-screen').classList.add('fade-out'); }, 2500); });
        let idleTimer;
        function resetIdleTimer() { clearTimeout(idleTimer); idleTimer = setTimeout(() => { document.querySelectorAll('.order-items-list.expanded').forEach(el => { el.classList.remove('expanded'); const btn = el.previousElementSibling; if(btn) btn.innerHTML = `<span><i class="fas fa-list"></i> View Items</span> <i class="fas fa-chevron-down"></i>`; }); }, 10000); }
        ['touchstart', 'click', 'scroll'].forEach(evt => document.addEventListener(evt, resetIdleTimer));
        window.toggleSearchOverlay = () => { const overlay = document.getElementById('header-search-overlay'); const isActive = overlay.classList.contains('active'); if(isActive) { overlay.classList.remove('active'); document.getElementById('global-search-input').blur(); } else { overlay.classList.add('active'); setTimeout(() => document.getElementById('global-search-input').focus(), 300); } };
        function preloadImages(items, key = 'image') { const urls = items.map(p => p[key]); urls.push("https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/FOOD%20APP%2FAddText_02-04-11.55.29.png?alt=media&token=12ebe32e-7475-4005-b153-ee5664b65f0c"); urls.forEach(url => { if(url) { const img = new Image(); img.src = url; } }); }

        /* =========================================
           SECTION: AUTH & INITIALIZATION
           ========================================= */
        onAuthStateChanged(auth, u=>{
            currentUser=u;
            setTimeout(() => {
                if(u){
                    document.getElementById('page-login').classList.add('hidden'); document.getElementById('page-register').classList.add('hidden'); document.getElementById('app-layout').classList.remove('hidden');
                    document.getElementById('orders-list').innerHTML = ""; document.getElementById('history-list').innerHTML = "";
                    fetchUserProfile(u.uid); initApp();
                    setTimeout(() => { notificationsAllowed = true; updateChatNotificationBanner(); }, 3000);
                } else {
                    document.getElementById('page-login').classList.remove('hidden'); document.getElementById('app-layout').classList.add('hidden');
                    currentUserProfile = {};
                    document.getElementById('profile-display-name').innerText = "Guest"; document.getElementById('profile-display-email').innerText = "";
                    document.getElementById('profile-avatar-img').src = "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";
                    document.getElementById('orders-list').innerHTML = ""; document.getElementById('history-list').innerHTML = "";
                }
            }, 500);
        });
        async function initApp(){fetchSettings();fetchCategories();fetchProducts();fetchRestaurants();}
        window.handleLogin=async()=>{const e=document.getElementById('login-email').value,p=document.getElementById('login-password').value;if(!e||!p)return;toggleLoader(true);try{await signInWithEmailAndPassword(auth,e,p);}catch(e){showCustomAlert(e.message, "Login Failed");}finally{toggleLoader(false);}};
        window.handleSignup=async()=>{ const n=document.getElementById('reg-name').value, e=document.getElementById('reg-email').value,p=document.getElementById('reg-password').value; if(!e||!p||!n)return;toggleLoader(true);try{const c=await createUserWithEmailAndPassword(auth,e,p);await set(ref(db,`users/${c.user.uid}/profile`),{email:e,displayName:n,createdAt:serverTimestamp()});showToast("Account created");}catch(e){showCustomAlert(e.message, "Signup Failed");}finally{toggleLoader(false);}};
        window.handleLogout=()=> { toggleLoader(true); localStorage.removeItem('cart'); cart = []; document.getElementById('orders-list').innerHTML = ""; document.getElementById('history-list').innerHTML = ""; document.getElementById('global-cart-items').innerHTML = ""; signOut(auth).then(() => { window.location.reload(); }); };

        /* =========================================
           SECTION: DATA FETCHING & UI RERENDER
           ========================================= */
        function updateAllUIs() { if(restaurants.length > 0 && products.length > 0) { renderRestaurants(); } updateCartUI(); listenToOrders(); }
        function fetchSettings(){onValue(ref(db,'settings/app_config'),s=>{if(s.exists()){appSettings={...appSettings,...s.val()}; document.getElementById('service-hours-display').innerText = `${appSettings.serviceStartTime} - ${appSettings.serviceEndTime}` || ''; }});}
        function fetchRestaurants(){ onValue(ref(db,'restaurants'), s => { restaurants = []; if(s.exists()){ s.forEach(snap => { restaurants.push({id: snap.key, ...snap.val()}); }); } preloadImages(restaurants, 'bannerImage'); updateAllUIs(); }); }
        function fetchCategories(){ onValue(ref(db,'categories'), s=>{ categories = []; if(s.exists()){ s.forEach(snap => { const cat=snap.val(); if(cat.active) categories.push({id:snap.key, ...cat}); }); categories.sort((a,b)=> (a.order||99) - (b.order||99)); } }); }
        function fetchProducts(){ onValue(ref(db,'products'),s=>{ products=[];if(s.exists()){const d=s.val();for(const k in d)products.push({id:k, ...d[k]});} products.sort((a,b)=>(a.productOrder||999999)-(b.productOrder||999999)); preloadImages(products, 'image'); updateAllUIs(); }); }
        function fetchUserProfile(uid){ onValue(ref(db,`users/${uid}`), s=>{ if(!s.exists()) return; currentUserProfile = s.val(); const p = currentUserProfile.profile || {}; document.getElementById('profile-display-name').innerText = p.displayName || 'Guest'; document.getElementById('profile-display-email').innerText = p.email; if(p.avatarUrl){ document.getElementById('profile-avatar-img').src = p.avatarUrl; document.getElementById('edit-avatar-preview').src = p.avatarUrl; } document.getElementById('prof-name').value = p.displayName || ''; document.getElementById('prof-phone').value = p.phone || ''; renderAddressCardUI(); }); }
        
        /* =========================================
           SECTION: ADDRESS LOGIC
           ========================================= */
        function renderAddressCardUI() { const addr = currentUserProfile.address; const card = document.getElementById('saved-address-card'); const addBtn = document.getElementById('add-address-btn-wrapper'); if(addr && addr.area) { card.classList.remove('hidden'); addBtn.classList.add('hidden'); document.getElementById('card-addr-area').innerText = addr.area; let details = ""; if(addr.area === 'DOHS') details = `Ave:${addr.avenue}, Rd:${addr.road}, H:${addr.house}`; else details = addr.details || "No details provided"; document.getElementById('card-addr-details').innerText = details; } else { card.classList.add('hidden'); addBtn.classList.remove('hidden'); } }
        window.prepareAddressEdit = () => { showPage('address'); addressImages = currentUserProfile.address?.houseImages || []; renderAddressImageSlots(); const addr = currentUserProfile.address; if(!addr) return; document.getElementById('addr-area').value = addr.area || ""; toggleAddressFields(); if(addr.area === 'DOHS') { document.getElementById('addr-dohs-avenue').value = addr.avenue || ""; document.getElementById('addr-dohs-road').value = addr.road || ""; document.getElementById('addr-dohs-house').value = addr.house || ""; } else { document.getElementById('addr-details').value = addr.details || ""; } document.getElementById('addr-contact-number').value = addr.contactNumber || ""; };
        window.toggleAddressFields = () => { const v = document.getElementById('addr-area').value; document.getElementById('dohs-fields').classList.toggle('hidden', v !== 'DOHS'); document.getElementById('other-area-field').classList.toggle('hidden', v === 'DOHS' || !v); };
        window.detectAddressLocation = () => { if(!navigator.geolocation) return showCustomAlert("GPS not supported or denied."); toggleLoader(true); navigator.geolocation.getCurrentPosition(async (p) => { const lat = p.coords.latitude; const lng = p.coords.longitude; const mapFrame = document.getElementById('addr-map-frame'); mapFrame.style.display = "block"; mapFrame.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://maps.google.com/maps?q=${lat},${lng}&z=17&output=embed"></iframe>`; try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`); const data = await res.json(); toggleLoader(false); if(data && data.display_name) { const addrText = document.getElementById('addr-detected-text'); addrText.style.display = "block"; addrText.innerHTML = `<b><i class="fas fa-check-circle" style="color:green"></i> Location Detected:</b><br>${data.display_name}`; document.getElementById('addr-details').value = data.display_name; } } catch(e) { toggleLoader(false); showToast("Could not get address text.", "error"); } }, (err) => { toggleLoader(false); showCustomAlert("Please allow Location Access"); }, {enableHighAccuracy: true}); };
        window.saveAddress = async () => { const a = { area: document.getElementById('addr-area').value, contactNumber: document.getElementById('addr-contact-number').value }; if(!a.area || !a.contactNumber) return showCustomAlert("Fill all required fields"); if(a.area === 'DOHS'){ a.avenue = document.getElementById('addr-dohs-avenue').value; a.road = document.getElementById('addr-dohs-road').value; a.house = document.getElementById('addr-dohs-house').value; } else { a.details = document.getElementById('addr-details').value; } toggleLoader(true); try { a.houseImages = addressImages; await set(ref(db, `users/${currentUser.uid}/address`), a); showToast("Address Saved Successfully"); showPage(previousPage); } catch(e) { showCustomAlert("Error saving address"); } finally { toggleLoader(false); } };
        window.handleAddressImages = (e) => { const files = Array.from(e.target.files); if(addressImages.length + files.length > 3) return showCustomAlert("Max 3 images allowed"); toggleLoader(true); const promises = files.map(f => uploadFile(f, 'house_images')); Promise.all(promises).then(urls => { addressImages = [...addressImages, ...urls]; renderAddressImageSlots(); toggleLoader(false); }).catch(() => { toggleLoader(false); showToast("Upload failed", "error"); }); };
        window.removeAddressImage = (idx) => { addressImages.splice(idx,1); renderAddressImageSlots(); };
        function renderAddressImageSlots(){ document.getElementById('addr-img-preview-grid').innerHTML = addressImages.map((url, i) => `<div class="img-slot"><img src="${url}"><div class="slot-del" onclick="removeAddressImage(${i})"><i class="fas fa-times"></i></div></div>`).join(''); }

        /* =========================================
           SECTION: RESTAURANT & PRODUCT UI
           ========================================= */
        function renderRestaurants() {
            const grid = document.getElementById('restaurant-grid');
            if (!grid) return;
            if (restaurants.length === 0 || products.length === 0) { grid.innerHTML = '<p>Loading restaurants...</p>'; return; }
            grid.innerHTML = restaurants.map(r => {
                const isOffline = r.isOffline === true;
                const productsOfRest = products.filter(p => p.restaurantId === r.id);
                let totalSavings = 0;
                let count = 0;
                productsOfRest.forEach(p => {
                   let comp = p.competitorPrice || p.price * 1.15;
                   totalSavings += (comp - p.price) / comp;
                   count++;
                });
                const avgSaving = count > 0 ? (totalSavings / count * 100).toFixed(0) : 0;
                
                return `<div class="restaurant-card ${isOffline ? 'offline' : ''}" onclick="${isOffline ? '' : `showPage('restaurant-menu', '${r.id}')`}">
                    ${isOffline ? '<div class="offline-badge">Service Off</div>' : ''}
                    <img src="${r.bannerImage}" class="restaurant-banner">
                    <div class="restaurant-info">
                        <div class="restaurant-name">${r.name}</div>
                        <div class="restaurant-meta">
                            <div class="meta-row">
                                <span class="delivery-pill"><i class="fas fa-motorcycle" style="color:var(--primary)"></i> Delivery 35+</span>
                                ${avgSaving > 0 ? `<span class="savings-pill"><i class="fas fa-tags"></i> Save ${avgSaving}%</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('') || '<p>No restaurants available.</p>';
        }

        function showRestaurantMenu(restaurantId) {
            activeRestaurantId = restaurantId;
            const restaurant = restaurants.find(r => r.id === restaurantId);
            if (!restaurant) { showToast("Restaurant not found", "error"); return; }
            
            setPage('restaurant-menu');
            document.getElementById('menu-hero-bg').style.backgroundImage = `url(${restaurant.bannerImage})`;
            document.getElementById('menu-hero-title').innerText = restaurant.name;
            document.getElementById('menu-hero-desc').innerText = restaurant.description || '';

            window.addEventListener('scroll', handleRestaurantScroll, { passive: true });

            const productsOfRestaurant = products.filter(p => p.restaurantId === restaurantId || p.restaurantId === 'global');
            const c = document.getElementById('category-filters-container');
            let catHtml = `<div class="filter-chip active" onclick="setCategory('all', this)"> All</div>`;
            categories.forEach(cat => { catHtml += `<div class="filter-chip" onclick="setCategory('${cat.id}', this)">${cat.icon||''} ${cat.name}</div>`; });
            c.innerHTML = catHtml;
            
            renderProducts(productsOfRestaurant);
            updateMenuCartBadge();
        }

        function handleRestaurantScroll() {
            if (currentPage !== 'restaurant-menu') {
                window.removeEventListener('scroll', handleRestaurantScroll);
                return;
            }
            const heroBg = document.getElementById('menu-hero-bg');
            let offset = window.scrollY;
            heroBg.style.transform = `translateY(${offset * 0.4}px)`;
        }

        function renderProducts(list){
            const listEl = document.getElementById('product-list');
            if(!listEl) return;
            listEl.innerHTML=list.map(p=>{
                const inCart = cart.find(x=>x.productId===p.id);
                const qtyHtml = inCart ? `<span style="background:var(--primary); color:white; padding:2px 8px; border-radius:10px; font-size:0.7rem;">${inCart.qty} in cart</span>` : '';
                return `<div class="product-card" onclick="openProductModal('${p.id}')"><img src="${p.image}" class="product-img"><div class="product-info"><div class="product-name">${p.name}</div><div class="product-meta"><span class="product-price">${formatPrice(p.price)}</span>${qtyHtml}<button class="btn-add" style="pointer-events:none"><i class="fas fa-plus"></i></button></div></div></div>`
            }).join('') || '<p>No items found in this category.</p>';
        }
        
        window.filterProductsSearch = (q) => { /* ... */ };
        window.selectSearchResult = (pid) => { /* ... */ };

        window.setCategory = (c, el) => { 
            document.querySelectorAll('#category-filters-container .filter-chip').forEach(e=>e.classList.remove('active')); 
            if(el) el.classList.add('active'); 
            const productsOfRestaurant = products.filter(p => p.restaurantId === activeRestaurantId || p.restaurantId === 'global');
            const filtered = c === 'all' ? productsOfRestaurant : productsOfRestaurant.filter(p => p.categoryId === c);
            renderProducts(filtered); 
        };

        /* =========================================
           SECTION: CART LOGIC
           ========================================= */
        window.openProductModal = (pid) => { const p = products.find(x=>x.id===pid); if(!p) return; document.getElementById('active-modal-pid').value = pid; document.getElementById('pm-img').src = p.image; document.getElementById('pm-name').innerText = p.name; document.getElementById('pm-price').innerText = formatPrice(p.price); document.getElementById('pm-desc').innerText = p.desc || 'No description available.'; const inCart = cart.find(x=>x.productId===pid); document.getElementById('pm-qty').innerText = inCart ? inCart.qty : 0; const m = document.getElementById('product-details-modal'); m.classList.add('active'); document.body.classList.add('no-scroll'); };
        window.closeProductModal = () => { const m = document.getElementById('product-details-modal'); m.classList.remove('active'); document.body.classList.remove('no-scroll'); renderProducts(products.filter(p => p.restaurantId === activeRestaurantId || p.restaurantId === 'global')); };
        
        window.adjustModalQty = (d) => {
            const pid = document.getElementById('active-modal-pid').value;
            const p = products.find(x=>x.id===pid); if(!p) return;
            const el = document.getElementById('pm-qty'); let currentQty = parseInt(el.innerText); let newQty = currentQty + d;
            if(newQty < 0) newQty = 0;
            el.innerText = newQty;
            if(d > 0) showMiniToast("Added to Cart", "add");
            if(d < 0 && currentQty > 0) showMiniToast("Removed from Cart", "remove");
            cart = cart.filter(x=>x.productId!==pid); 
            if(newQty > 0) { cart.push({ productId:pid, name:p.name, price:p.price, competitorPrice: p.competitorPrice || 0, image:p.image, qty:newQty, restaurantId: p.restaurantId }); }
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI(); 
            updateMenuCartBadge();
        };
        
        function updateCartUI(){
            const count = cart.reduce((a,b)=>a+b.qty,0);
            const badge = document.getElementById('nav-badge-count');
            badge.innerText = count; badge.classList.toggle('show', count > 0);
            document.getElementById('nav-btn-cart').classList.toggle('has-items', count > 0);
        }

        function renderGlobalCartPage() {
            const container = document.getElementById('global-cart-items');
            if (cart.length === 0) { container.innerHTML = "<p style='text-align:center; margin-top:20px; color:var(--text-muted)'>Your cart is empty</p>"; return; }

            const groupedCart = cart.reduce((acc, item) => { (acc[item.restaurantId] = acc[item.restaurantId] || []).push(item); return acc; }, {});
            container.innerHTML = Object.keys(groupedCart).map(restaurantId => {
                const restaurant = restaurants.find(r => r.id === restaurantId);
                const items = groupedCart[restaurantId];
                if (!restaurant) return '';
                const itemCount = items.reduce((sum, item) => sum + item.qty, 0);
                const previewItems = items.slice(0, 2).map(i => `<div class="crs-item-preview"><img src="${i.image}" class="crs-item-img"><div>${i.qty}x ${i.name}</div></div>`).join('');
                const moreText = items.length > 2 ? `<div style="font-size:0.8rem;color:var(--text-muted);margin-left:60px;">+${items.length - 2} more items...</div>` : '';

                return `<div class="cart-restaurant-summary">
                        <div class="crs-header"><img src="${restaurant.bannerImage}" class="crs-logo"><span class="crs-name">${restaurant.name}</span></div>
                        <div class="crs-item-preview-list">${previewItems}${moreText}</div>
                        <button class="btn btn-primary" onclick="openCartReview('${restaurantId}')">View Cart (${itemCount} items)</button>
                    </div>`;
            }).join('');
        }

        function updateMenuCartBadge() {
            if (!activeRestaurantId) return;
            const count = cart.filter(item => item.restaurantId === activeRestaurantId).reduce((sum, item) => sum + item.qty, 0);
            const badge = document.getElementById('menu-cart-badge');
            if (badge) {
                badge.innerText = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }
        
        window.openCartReviewForCurrentRestaurant = () => {
            const itemsInCartForRestaurant = cart.filter(item => item.restaurantId === activeRestaurantId).length > 0;
            if (activeRestaurantId && itemsInCartForRestaurant) {
                openCartReview(activeRestaurantId);
            } else {
                showToast("Cart is empty for this restaurant", "error");
            }
        };

        window.openCartReview = (restaurantId) => {
            checkoutRestaurantId = restaurantId;
            const restaurant = restaurants.find(r => r.id === restaurantId);
            if (!restaurant) return;

            document.getElementById('cr-restaurant-name').innerText = restaurant.name;
            renderCartReviewItems();

            const modal = document.getElementById('cart-review-modal');
            modal.classList.add('active');
            document.body.classList.add('no-scroll');
            initModalDrag();
        };

        window.closeCartReview = () => {
            document.getElementById('cart-review-modal').classList.remove('active');
            document.body.classList.remove('no-scroll');
        };
        
        function initModalDrag() {
            const modal = document.getElementById('cart-review-modal');
            const content = document.getElementById('cart-review-content');
            const header = document.getElementById('cart-review-header');
            
            let startY = 0;
            let currentY = 0;
            
            const touchStart = (e) => { startY = e.touches[0].clientY; };
            const touchMove = (e) => { currentY = e.touches[0].clientY; const diff = currentY - startY; if (diff > 0) { content.style.transform = `translateY(${diff}px)`; } };
            const touchEnd = (e) => { const diff = currentY - startY; if (diff > 80) { closeCartReview(); } content.style.transform = ''; startY = 0; currentY = 0; };
            
            header.addEventListener('touchstart', touchStart);
            header.addEventListener('touchmove', touchMove);
            header.addEventListener('touchend', touchEnd);
        }
        
        function renderCartReviewItems() {
            const itemsList = document.getElementById('cr-items-list');
            const totalEl = document.getElementById('cr-total');
            const cartItems = cart.filter(item => item.restaurantId === checkoutRestaurantId);
            let subtotal = 0;

            if (cartItems.length === 0) {
                itemsList.innerHTML = `<p style="text-align:center; color:var(--text-muted)">This cart is empty.</p>`;
                totalEl.innerText = formatPrice(0);
                return;
            }

            itemsList.innerHTML = cartItems.map(item => {
                subtotal += item.price * item.qty;
                return `
                <div class="cr-item-row">
                    <img src="${item.image}" class="cart-item-img">
                    <div class="cr-item-info">
                        <div class="cr-item-name">${item.name}</div>
                        <div class="cr-item-price">${formatPrice(item.price)}</div>
                    </div>
                    <div class="cart-qty-control">
                        <button class="qty-mini-btn" onclick="adjustCartReviewQty('${item.productId}', -1)"><i class="fas fa-minus"></i></button>
                        <span class="cr-qty-val">${item.qty}</span>
                        <button class="qty-mini-btn plus" onclick="adjustCartReviewQty('${item.productId}', 1)"><i class="fas fa-plus"></i></button>
                    </div>
                </div>`;
            }).join('');
            totalEl.innerText = formatPrice(subtotal);
        }

        window.adjustCartReviewQty = (productId, delta) => {
            const itemIndex = cart.findIndex(item => item.productId === productId);
            if (itemIndex === -1) return;
            cart[itemIndex].qty += delta;
            if (cart[itemIndex].qty <= 0) {
                cart.splice(itemIndex, 1);
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
            updateMenuCartBadge();
            
            const remainingItems = cart.filter(item => item.restaurantId === checkoutRestaurantId);
            if(remainingItems.length === 0) {
                closeCartReview();
                renderGlobalCartPage();
            } else {
                renderCartReviewItems();
            }
        };

        window.proceedToFinalCheckout = () => {
            closeCartReview();
            setTimeout(() => {
                showFinalCheckoutPage();
            }, 300);
        };


        /* =========================================
           SECTION: CHECKOUT & ORDERS
           ========================================= */
        
        // NEWLY ADDED: The missing setTip function
        window.setTip = (amount, el, isManual = false) => {
            riderTip = parseInt(amount) || 0;
            document.querySelectorAll('.tip-card').forEach(c => c.classList.remove('selected'));
            if (el) {
                el.classList.add('selected');
                document.getElementById('tip-manual').value = "";
            }
            if (isManual) {
                const matchingButton = [...document.querySelectorAll('.tip-card')].find(card => {
                    const onclickValue = card.getAttribute('onclick');
                    const valueInButton = parseInt(onclickValue.match(/setTip\((\d+)/)[1]);
                    return valueInButton === riderTip;
                });
                if (matchingButton) {
                    matchingButton.classList.add('selected');
                }
            }
            calculateCheckoutTotal();
        };

        function showFinalCheckoutPage(){
            const checkoutCart = cart.filter(item => item.restaurantId === checkoutRestaurantId);
            if(!checkoutCart.length)return showCustomAlert("Your cart for this restaurant is empty!");
            if(!currentUserProfile.address?.area){showCustomAlert("Please add a delivery address first.");showPage('address');return;}
            
            const restaurant = restaurants.find(r => r.id === checkoutRestaurantId);
            if (!restaurant) return showCustomAlert("Restaurant not found.");
            
            showPage('checkout');
            
            const userArea = currentUserProfile.address.area;
            const baseFeeFromAdmin = restaurant.deliveryCharges?.[userArea] || 35; 
            deliveryPriority = 'normal';
            document.getElementById('opt-normal').classList.add('active'); document.getElementById('opt-fast').classList.remove('active');
            const isFreeDelivery = (userTotalDeliveredOrders % 7) === 6;
            
            if(isFreeDelivery) {
                document.getElementById('fee-normal').innerHTML = `<span style="text-decoration:line-through; color:grey">${baseFeeFromAdmin} </span> <span style="color:#00C853; font-weight:800">FREE</span>`;
                document.getElementById('fee-fast').innerHTML = `<span style="text-decoration:line-through; color:grey">${baseFeeFromAdmin + 20} </span> <span style="color:#FF5722; font-weight:800">20 </span>`;
            } else { 
                document.getElementById('fee-normal').innerText = baseFeeFromAdmin + " "; 
                document.getElementById('fee-fast').innerText = (baseFeeFromAdmin + 20) + " "; 
            }
            
            initSwipeButton();
            renderPaymentMethods();
            calculateCheckoutTotal();
        };

        window.closeCheckout = () => {
             showPage('global-cart');
        };
        
        window.setDeliveryPriority = (type, el) => { deliveryPriority = type; document.querySelectorAll('.del-opt-card').forEach(c => c.classList.remove('active')); el.classList.add('active'); calculateCheckoutTotal(); };

        function calculateCheckoutTotal(){ 
            const checkoutCart = cart.filter(item => item.restaurantId === checkoutRestaurantId);
            if(checkoutCart.length === 0) { 
                document.getElementById('co-subtotal').innerText = formatPrice(0);
                document.getElementById('co-grand').innerText = formatPrice(0);
                return;
            }
            document.getElementById('checkout-items-list').innerHTML = checkoutCart.map(i => 
                `<div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                    <span>${i.qty}x ${i.name}</span>
                    <span>${formatPrice(i.price*i.qty)}</span>
                </div>`
            ).join('');

            const restaurant = restaurants.find(r => r.id === checkoutRestaurantId); 
            const userArea = currentUserProfile.address.area; 
            const baseDeliveryFee = restaurant.deliveryCharges?.[userArea] || 35; 
            const subTotal = checkoutCart.reduce((a,b)=>a+b.price*b.qty,0); 
            const isFreeDelivery = (userTotalDeliveredOrders % 7) === 6; 
            let delivery = baseDeliveryFee; 
            if(isFreeDelivery) delivery = 0; 
            if(deliveryPriority === 'fast') delivery += 20; 
            const tip = riderTip; 
            const preTotal = subTotal + delivery + tip; 
            if(selectedPayment !== 'cod' && selectedPayment !== null) { 
                cashOutFee = Math.ceil((preTotal / 1000) * 15); 
                document.getElementById('row-cashout').classList.remove('hidden'); 
                document.getElementById('co-cashout').innerText = formatPrice(cashOutFee); 
            } else { 
                cashOutFee = 0; 
                document.getElementById('row-cashout').classList.add('hidden'); 
            } 
            const grandTotal = preTotal + cashOutFee; 
            document.getElementById('co-subtotal').innerText = formatPrice(subTotal); 
            document.getElementById('co-delivery').innerText = formatPrice(delivery); 
            document.getElementById('co-tip').innerText = formatPrice(tip); 
            document.getElementById('co-grand').innerText = formatPrice(grandTotal); 
            const box = document.getElementById('price-compare-box'); 
            if (box) {
                document.getElementById('comp-banner-img').src = appSettings.compareBannerUrl || ""; 
                document.getElementById('comp-logo-img').src = appSettings.competitorLogo || ""; 
                document.getElementById('cmp-mf-price').innerText = formatPrice(grandTotal); 
                const compItemTotal = checkoutCart.reduce((a, item) => { let cPrice = (item.competitorPrice && item.competitorPrice > 0) ? item.competitorPrice : Math.ceil(item.price * 1.15); return a + (cPrice * item.qty); }, 0); 
                let compDelivery = baseDeliveryFee; if(deliveryPriority === 'fast') compDelivery += 20; 
                const compTotal = compItemTotal + compDelivery + tip + cashOutFee; 
                document.getElementById('cmp-other-price').innerText = formatPrice(compTotal); 
                const savings = compTotal - grandTotal; 
                if(savings > 0) { 
                    document.getElementById('cmp-save-amt').innerHTML = `YOU SAVE: ${formatPrice(savings)}`; 
                    box.classList.remove('hidden'); 
                } else { 
                    box.classList.add('hidden'); 
                }
            } 
            renderAddressDisplay();
        }

        function renderPaymentMethods(){ const c=document.getElementById('payment-methods-container'),m=appSettings.paymentMethods; c.innerHTML=""; if(m.cod) c.innerHTML+=getPayHTML('cod','Cash on Delivery','fas fa-money-bill-wave'); if(m.bkash) c.innerHTML+=getPayHTML('bkash','bKash','fas fa-mobile-alt',appSettings.paymentNumbers.bkash); if(m.nagad) c.innerHTML+=getPayHTML('nagad','Nagad','fas fa-mobile-alt',appSettings.paymentNumbers.nagad); if(m.rocket) c.innerHTML+=getPayHTML('rocket','Rocket','fas fa-rocket',appSettings.paymentNumbers.rocket || ''); }
        function getPayHTML(id,name,icon,num){ return `<div class="pay-option" id="pm-${id}" onclick="selectPayment('${id}')"><div class="pay-icon"><i class="${icon}"></i></div><div class="pay-info"><span class="pay-title">${name}</span>${id!=='cod'?`<span class="pay-desc">Send Money</span>`:''}</div><div class="radio-circle"></div></div>${id!=='cod'?`<div id="details-${id}" class="hidden" style="padding:15px; background:var(--input-bg); border-radius:12px; margin-bottom:15px; border:1px solid var(--border-color);"><p style="font-size:0.9rem; margin-bottom:5px; color:var(--text-main);">Send Money to: <b>${num}</b></p><div class="pay-desc-fee" style="font-size:0.85rem; background:var(--bg-card); padding:5px; margin-bottom:10px; color:var(--text-main);"></div><input id="sender-${id}" class="form-control" placeholder="Sender Number" style="margin-bottom:8px"><input id="trx-${id}" class="form-control" placeholder="Transaction ID"></div>`:''}`; }
        window.selectPayment=id=>{ selectedPayment=id; document.querySelectorAll('.pay-option').forEach(e=>e.classList.remove('selected')); document.getElementById(`pm-${id}`).classList.add('selected'); document.querySelectorAll('[id^="details-"]').forEach(e=>e.classList.add('hidden')); if(document.getElementById(`details-${id}`)) document.getElementById(`details-${id}`).classList.remove('hidden'); const warnBox = document.getElementById('online-payment-warning'); if(id !== 'cod') { warnBox.classList.remove('hidden'); const method = id === 'bkash' ? 'bKash' : (id === 'nagad' ? 'Nagad' : 'Rocket'); warnBox.innerText = `  ${method}  ,               (   )`; } else { warnBox.classList.add('hidden'); } calculateCheckoutTotal(); };
        window.getLocation=()=>{ const box=document.getElementById('loc-box'), title=document.getElementById('loc-title-text'), status=document.getElementById('loc-status-text'), mapDiv=document.getElementById('loc-map-preview'), addrTxt=document.getElementById('loc-address-text'); if(!navigator.geolocation) return; status.innerText="Loading Map..."; title.innerText="Locating..."; navigator.geolocation.getCurrentPosition(async p=>{ const lat = p.coords.latitude; const lng = p.coords.longitude; locationData={enabled:true, lat:lat, lng:lng}; box.classList.add('active'); title.innerHTML=`<i class="fas fa-check-circle"></i> Live Location Attached`; status.innerText="Map loaded below"; mapDiv.classList.remove('hidden'); mapDiv.innerHTML = `<iframe class="map-preview-frame" src="https://maps.google.com/maps?q=${lat},${lng}&z=15&output=embed"></iframe>`; try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`); const data = await res.json(); if(data && data.display_name) { addrTxt.classList.remove('hidden'); addrTxt.innerHTML = `<b>Google Map  :</b><br>${data.display_name}`; } } catch(e) { console.log(e); } },e=>{ status.innerText="Failed. Try enabling GPS."; }); };
        window.attachLocationToOrder = (orderId) => { if(!navigator.geolocation) return showCustomAlert("Permission denied"); toggleLoader(true); navigator.geolocation.getCurrentPosition(async p => { try { await update(ref(db, `orders/${currentUser.uid}/${orderId}`), { location: { enabled: true, lat: p.coords.latitude, lng: p.coords.longitude } }); showToast("Location Updated!"); } catch(e) { showCustomAlert("Error updating location"); } finally { toggleLoader(false); } }, e => { toggleLoader(false); showCustomAlert("Could not get location"); }); };
        function initSwipeButton() { const btn = document.getElementById('swipe-btn'); const handle = document.getElementById('swipe-handle'); const bg = document.getElementById('swipe-bg'); if(!btn || !handle) return; let isDragging = false, startX, containerWidth; const startDrag = (e) => { isDragging = true; startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX; containerWidth = btn.offsetWidth - handle.offsetWidth; }; const moveDrag = (e) => { if(!isDragging) return; if(e.type === 'touchmove') e.preventDefault(); let currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX; let diff = currentX - startX; if(diff < 0) diff = 0; if(diff > containerWidth) diff = containerWidth; handle.style.left = diff + 'px'; bg.style.width = diff + 'px'; if(diff >= containerWidth - 5) { isDragging = false; handle.style.left = containerWidth + 'px'; showOrderConfirmation(); } }; const endDrag = () => { if(!isDragging) return; isDragging = false; handle.style.transition = 'left 0.3s, width 0.3s'; bg.style.transition = 'width 0.3s'; handle.style.left = '0px'; bg.style.width = '0px'; setTimeout(() => { handle.style.transition = ''; bg.style.transition = ''; }, 300); }; handle.addEventListener('mousedown', startDrag); handle.addEventListener('touchstart', startDrag); document.addEventListener('mousemove', moveDrag); document.addEventListener('touchmove', moveDrag, {passive: false}); document.addEventListener('mouseup', endDrag); document.addEventListener('touchend', endDrag); }
        function resetCheckoutState() { riderTip = 0; document.getElementById('tip-manual').value = ""; document.getElementById('rider-note').value = ""; document.getElementById('location-link-input').value = ""; locationData={enabled:false}; document.getElementById('loc-map-preview').innerHTML = ""; document.getElementById('loc-map-preview').classList.add('hidden'); document.getElementById('loc-address-text').innerHTML = ""; document.getElementById('loc-address-text').classList.add('hidden'); document.getElementById('loc-box').classList.remove('active'); document.getElementById('loc-title-text').innerHTML = '<i class="fas fa-map-marker-alt"></i> Share Live Location'; document.getElementById('loc-status-text').innerText = "Tap to enable map"; document.getElementById('swipe-handle').style.left = '0'; document.getElementById('swipe-bg').style.width = '0'; selectedPayment = null; document.querySelectorAll('.pay-option').forEach(e => e.classList.remove('selected')); document.querySelectorAll('[id^="details-"]').forEach(e => e.classList.add('hidden')); document.querySelectorAll('.tip-card').forEach(c => c.classList.remove('selected')); }
        let confirmationTimer = null;
        window.showOrderConfirmation = () => { const checkoutCart = cart.filter(item => item.restaurantId === checkoutRestaurantId); if(!checkoutCart.length) { resetSwipe(); return showCustomAlert("Cart empty"); } if(!currentUserProfile.address?.area){ resetSwipe(); showCustomAlert("Set address first"); showPage('address'); return; } if(!selectedPayment) { const btn = document.getElementById('swipe-btn'); btn.classList.add('shake-it'); setTimeout(() => btn.classList.remove('shake-it'), 400); resetSwipe(); return showCustomAlert("Select payment method"); } if(selectedPayment !== 'cod') { const s = document.getElementById(`sender-${selectedPayment}`).value; const t = document.getElementById(`trx-${selectedPayment}`).value; if(!s || !t) { resetSwipe(); return showCustomAlert("Enter payment details"); } } const modal = document.getElementById('confirm-order-modal'); const btn = document.getElementById('btn-confirm-final'); modal.classList.add('active'); btn.classList.add('disabled'); let count = 5; btn.innerText = `  (${count}s)`; if(confirmationTimer) clearInterval(confirmationTimer); confirmationTimer = setInterval(() => { count--; if(count <= 0) { clearInterval(confirmationTimer); btn.classList.remove('disabled'); btn.innerText = " "; } else { btn.innerText = `  (${count}s)`; } }, 1000); };
        function resetSwipe() { document.getElementById('swipe-handle').style.left = '0'; document.getElementById('swipe-bg').style.width = '0'; }
        window.confirmAndPlaceOrder = async () => { document.getElementById('confirm-order-modal').classList.remove('active'); if(isOrderProcessing) return; isOrderProcessing = true; toggleLoader(true); const checkoutCart = cart.filter(item => item.restaurantId === checkoutRestaurantId); const restaurant = restaurants.find(r => r.id === checkoutRestaurantId); const userArea = currentUserProfile.address.area; const baseDeliveryFee = restaurant.deliveryCharges?.[userArea] || 35; const sub = checkoutCart.reduce((a,b)=>a+b.price*b.qty,0); const isFreeDelivery = (userTotalDeliveredOrders % 7) === 6; let del = baseDeliveryFee; if(isFreeDelivery) del = 0; if(deliveryPriority === 'fast') del += 20; const preGrand = sub + del + riderTip; let finalCashOutFee = 0; if(selectedPayment !== 'cod') finalCashOutFee = Math.ceil((preGrand / 1000) * 15); const grand = preGrand + finalCashOutFee; const riderNote = document.getElementById('rider-note').value; const mapLink = document.getElementById('location-link-input').value; if(mapLink) { locationData.manualLink = mapLink; locationData.enabled = true; } let payInfo={method:selectedPayment, status:'pending'}; if(selectedPayment !== 'cod'){ const s=document.getElementById(`sender-${selectedPayment}`).value; const t=document.getElementById(`trx-${selectedPayment}`).value; payInfo={ ...payInfo, senderNumber:s, trxId:t, amount:preGrand, cashOutCharge:finalCashOutFee, finalPayable:grand, adminNumber:appSettings.paymentNumbers[selectedPayment] }; } else { payInfo.status='cod'; payInfo.finalPayable = grand; } try { const orderRef = push(ref(db, `orders/${currentUser.uid}`)); await set(orderRef, { userId:currentUser.uid, restaurantId: checkoutRestaurantId, address:currentUserProfile.address, items:checkoutCart, totals:{ subTotal:sub, deliveryCharge:del, riderTip:riderTip, cashOutFee:finalCashOutFee, grandTotal:grand }, payment:payInfo, location:locationData, riderNote: riderNote, status:'pending', createdAt:serverTimestamp(), deliveryPriority: deliveryPriority }); cart = cart.filter(item => item.restaurantId !== checkoutRestaurantId); localStorage.setItem('cart', JSON.stringify(cart)); updateCartUI(); renderGlobalCartPage(); resetCheckoutState(); showPage('orders'); toggleLoader(false); const overlay = document.getElementById('success-overlay'); overlay.style.opacity = '1'; setTimeout(() => { overlay.style.opacity = '0'; isOrderProcessing = false; }, 2000); } catch(e){ isOrderProcessing = false; toggleLoader(false); resetSwipe(); showCustomAlert(e.message); } };
        function listenToOrders(){ if(!currentUser)return; onValue(ref(db,`orders/${currentUser.uid}`),s=>{ const al=document.getElementById('orders-list'), hl=document.getElementById('history-list'); al.innerHTML=""; hl.innerHTML=""; if(!s.exists()){al.innerHTML="<p style='text-align:center; margin-top:20px; color:var(--text-muted)'>No active orders</p>"; return;} const o=[]; s.forEach(c => { if(c.val() && c.val().status) o.push({id:c.key, ...c.val()}); }); o.sort((a,b)=>b.createdAt-a.createdAt); let deliveredOrders=0, totalSpent=0, totalCompetitorCost = 0, deliveryCostSaved = 0; o.forEach(d=>{ const isHist = d.status==='delivered' || d.status==='cancelled'; const payAmount = d.payment.finalPayable || d.totals.grandTotal; 
        
        if(d.status === 'delivered') { if (deliveredOrders % 7 === 6) { deliveryCostSaved += 35; } deliveredOrders++; totalSpent += payAmount; let compItemsTotalForThisOrder = d.items.reduce((a, i) => a + (i.competitorPrice || Math.ceil(i.price * 1.15)) * i.qty, 0); totalCompetitorCost += compItemsTotalForThisOrder + d.totals.deliveryCharge + (d.totals.riderTip || 0) + (d.payment.cashOutCharge || 0); if(d.riderId) { remove(ref(db, `chats/${d.id}`)); } } let bannerUrl = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/FOOD%20APP%2FAddText_02-03-05.58.24.png?alt=media&token=1628bba5-6fd0-4c6c-a25c-150a3411de56"; if(d.status === 'delivered') bannerUrl = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/FOOD%20APP%2FOdder%20compelet.png?alt=media&token=fff2254f-e127-4be1-b155-850a76b69d7c"; const steps = ['pending', 'accepted', 'ontheway', 'delivered']; const currentStepIdx = steps.indexOf(d.status.toLowerCase()); const renderStep = (label, idx, icon) => { let cls = ''; if(d.status === 'cancelled') cls = 'cancelled'; else if(idx <= currentStepIdx) cls = 'active'; return `<div class="step ${cls}"><div class="step-circle"><i class="fas ${icon}"></i></div><div class="step-label">${label}</div></div>`; }; let footerHtml = '', bengaliMsg = ''; if(d.status === 'cancelled') { footerHtml = `<div class="cancelled-badge"> ORDER CANCELLED</div>`; } else if(d.payment.method === 'cod') { footerHtml = `<div class="pay-method-text"><i class="fas fa-money-bill-wave" style="color:#4CAF50"></i> Cash on Delivery</div><div class="collect-badge">COLLECT: ${formatPrice(payAmount)}</div>`; } else { const isPaid = d.payment.status === 'approved' || d.status === 'delivered'; let statusText = isPaid ? `<span class="online-paid-text">ONLINE PAID</span>` : `<span style="font-size:0.8rem; font-weight:700; color:#FF9800">PENDING</span>`; if(!isPaid) bengaliMsg = `<div class="bengali-warning">         ,    </div>`; footerHtml = `<div class="pay-method-text"><i class="fas fa-mobile-alt" style="color:var(--primary)"></i> ${d.payment.method.toUpperCase()}</div><div style="display:flex; align-items:center; gap:10px;">${statusText}<button class="view-pay-btn" onclick="viewPaymentDetails('${d.payment.method}', '${d.payment.senderNumber}', '${d.payment.trxId}', '${payAmount}')">View Info</button></div>`; } let locBtn = ''; if((!d.location || !d.location.enabled) && !isHist) { locBtn = `<div style="padding:0 15px 15px 15px;"><button class="live-loc-order-btn" onclick="attachLocationToOrder('${d.id}')"><i class="fas fa-map-marker-alt"></i> Share Live Location</button></div>`; } let chatBtn = ''; if(d.riderId && !isHist) { chatBtn = `<div class="chat-btn-circle" id="chat-btn-${d.id}" onclick="openChat('${d.id}', '${d.riderId}', '${d.riderName}')"><i class="fas fa-comment-dots"></i><div class="chat-red-dot" id="badge-${d.id}"></div></div>`; listenChat(d.id, d.riderName || 'Rider'); } const itemsHtml = d.items.map(i => `<div class="item-row"><img src="${i.image}" class="item-thumb"><div class="item-details"><div>${i.qty}x ${i.name}</div></div><div class="item-price">${formatPrice(i.price * i.qty)}</div></div>`).join(''); let emergencyBadge = d.deliveryPriority === 'fast' ? `<span style="background:#FF3D00; color:white; font-size:0.7rem; padding:2px 6px; border-radius:4px; margin-left:10px;">EMERGENCY </span>` : ''; const html = `<div class="order-card-new"><img src="${bannerUrl}" class="order-banner"><div class="order-header-info"><div style="display:flex; justify-content:space-between; align-items:center"><div><span class="order-code-lg">ORDER #${d.id.slice(-6).toUpperCase()} ${emergencyBadge}</span><span class="order-date-sm">${new Date(d.createdAt).toLocaleString()}</span></div>${chatBtn}</div></div><div class="stepper-wrapper"><div class="stepper">${renderStep('Pending', 0, 'fa-clock')}${renderStep('Accepted', 1, 'fa-check')}${renderStep('On Way', 2, 'fa-motorcycle')}${renderStep('Completed', 3, 'fa-home')}</div></div>${bengaliMsg}<div class="order-items-toggle" onclick="toggleItems(this)"><span><i class="fas fa-list"></i> View Items (${d.items.reduce((a,b)=>a+b.qty,0)})</span><i class="fas fa-chevron-down"></i></div><div class="order-items-list">${itemsHtml}<div class="total-bill-row"><span>Total Bill</span><span>${formatPrice(payAmount)}</span></div></div>${locBtn}<div class="payment-footer">${footerHtml}</div>${d.status==='delivered' && !d.rating ? `<div style="padding:0 15px 15px 15px"><button class="btn btn-sm btn-outline" style="width:100%" onclick="openRating('${d.id}')">Rate Order</button></div>`:''}</div>`; if(isHist) { hl.innerHTML += html; } else { al.innerHTML += html; } }); userTotalDeliveredOrders = deliveredOrders; const totalSavedAmount = Math.max(0, (totalCompetitorCost - totalSpent)); document.getElementById('rep-competitor').innerText = formatPrice(totalCompetitorCost); document.getElementById('rep-spent').innerText = formatPrice(totalSpent); document.getElementById('rep-del-saved').innerText = formatPrice(deliveryCostSaved); document.getElementById('rep-saved').innerText = formatPrice(totalSavedAmount); renderLoyaltyTrack(deliveredOrders); }); }
        
        function renderLoyaltyTrack(deliveredCount) { const container = document.getElementById('loyalty-track-container'); if(!container) return; const position = deliveredCount % 7; let html = ''; for(let i=0; i<6; i++) { const isFilled = i < position; html += `<div class="track-step ${isFilled ? 'filled' : ''}">${isFilled ? '<i class="fas fa-check"></i>' : (i+1)}</div>`; } const isFreeActive = (position === 6); html += `<div class="track-step free-step ${isFreeActive ? 'active' : ''}"><i class="fas fa-gift"></i></div><div class="track-line"></div><div class="track-progress" style="width:${Math.min((position / 6) * 100, 100)}%"></div>`; container.innerHTML = html; }
        window.toggleItems = (btn) => { resetIdleTimer(); const list = btn.nextElementSibling; list.classList.toggle('expanded'); const icon = btn.querySelector('.fa-chevron-down') || btn.querySelector('.fa-chevron-up'); icon.className = list.classList.contains('expanded') ? 'fas fa-chevron-up' : 'fas fa-chevron-down'; };
        window.viewPaymentDetails = (method, sender, trx, amount) => { document.getElementById('md-method').innerText = method.toUpperCase(); document.getElementById('md-sender').innerText = sender; document.getElementById('md-trx').innerText = trx; document.getElementById('md-amount').innerText = formatPrice(amount); document.getElementById('pay-details-modal').classList.remove('hidden'); };
        window.openChat = (orderId, riderId, riderName) => { activeChatOrderId = orderId; activeChatRiderId = riderId; document.getElementById('chat-rider-name').innerText = riderName || "Rider"; document.getElementById('chat-messages').innerHTML = ""; const badge = document.getElementById(`badge-${orderId}`); if(badge) badge.classList.remove('visible'); unreadChatQueue.forEach(item => dismissedMessages.add(item.key)); unreadChatQueue = unreadChatQueue.filter(x => x.orderId !== orderId); updateChatNotificationBanner(); document.getElementById('chat-modal').style.opacity = '1'; document.getElementById('chat-modal').style.pointerEvents = 'auto'; if (chatListeners[orderId]) { off(ref(db, `chats/${orderId}/messages`)); delete chatListeners[orderId]; } listenChat(orderId, riderName); listenTyping(orderId, riderId); };
        window.closeChat = () => { document.getElementById('chat-modal').style.opacity = '0'; document.getElementById('chat-modal').style.pointerEvents = 'none'; activeChatOrderId = null; };
        const chatListeners = {};
        function listenChat(orderId, riderName) { if(chatListeners[orderId]) return; const chatRef = ref(db, `chats/${orderId}/messages`); const listener = onChildAdded(chatRef, (snapshot) => { const msg = snapshot.val(); const key = snapshot.key; if (activeChatOrderId === orderId) { renderMessage(msg, key); if(msg.senderId !== currentUser.uid && !msg.seen) { update(ref(db, `chats/${orderId}/messages/${key}`), { seen: true }); dismissedMessages.add(key); } } if (msg.senderId !== currentUser.uid) { if (activeChatOrderId !== orderId) { if (!msg.seen && !dismissedMessages.has(key)) { const badge = document.getElementById(`badge-${orderId}`); if(badge) badge.classList.add('visible'); const exists = unreadChatQueue.find(x => x.key === key); if(!exists) { unreadChatQueue.push({ key: key, orderId: orderId, riderName: riderName || "Rider", riderId: msg.senderId, text: msg.text }); updateChatNotificationBanner(); } } } } }); chatListeners[orderId] = listener; }
        function updateChatNotificationBanner() { const banner = document.getElementById('global-chat-notification'); const msgEl = document.getElementById('gcn-message'); const badgeEl = document.getElementById('gcn-badge'); if(!notificationsAllowed) return; if (unreadChatQueue.length > 0) { const latest = unreadChatQueue[unreadChatQueue.length - 1]; msgEl.innerText = `From ${latest.riderName}`; if (unreadChatQueue.length > 1) { badgeEl.classList.remove('hidden'); badgeEl.innerText = `+${unreadChatQueue.length - 1}`; } else { badgeEl.classList.add('hidden'); } banner.classList.add('active'); } else { banner.classList.remove('active'); } }
        window.handleChatNotificationClick = () => { if(unreadChatQueue.length > 0) { const latest = unreadChatQueue[unreadChatQueue.length - 1]; showPage('orders'); openChat(latest.orderId, latest.riderId, latest.riderName); unreadChatQueue.forEach(item => dismissedMessages.add(item.key)); unreadChatQueue = []; updateChatNotificationBanner(); } };
        window.closeChatNotification = (e) => { e.stopPropagation(); unreadChatQueue.forEach(item => dismissedMessages.add(item.key)); unreadChatQueue = []; updateChatNotificationBanner(); };
        function listenTyping(orderId, riderId) { const statusDiv = document.getElementById('chat-status-text'); onValue(ref(db, `chats/${orderId}/typing/${riderId}`), (snap) => { if(snap.val() === true) { statusDiv.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div> Typing...`; } else { statusDiv.innerText = "Active now"; } }); const input = document.getElementById('chat-input-field'); input.addEventListener('input', () => { update(ref(db, `chats/${orderId}/typing/${currentUser.uid}`), true); clearTimeout(window.typingTimeout); window.typingTimeout = setTimeout(() => { update(ref(db, `chats/${orderId}/typing/${currentUser.uid}`), false); }, 1500); }); }
        function renderMessage(msg, key) { if(document.getElementById(`msg-${key}`)) return; const container = document.getElementById('chat-messages'); const isMe = msg.senderId === currentUser.uid; let checkIcon = ''; if(isMe) { const seenClass = msg.seen ? 'read' : ''; checkIcon = `<i class="fas fa-check-double seen-icon ${seenClass}" id="seen-${key}"></i>`; onValue(ref(db, `chats/${activeChatOrderId}/messages/${key}/seen`), (s)=>{ if(s.val()===true) { const icon = document.getElementById(`seen-${key}`); if(icon) icon.classList.add('read'); } }); } const html = `<div class="msg-bubble ${isMe ? 'sent' : 'received'}" id="msg-${key}">${msg.text}<div class="msg-meta">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}${checkIcon}</div></div>`; container.insertAdjacentHTML('beforeend', html); container.scrollTop = container.scrollHeight; }
        window.sendMessage = async () => { const input = document.getElementById('chat-input-field'); const text = input.value.trim(); if(!text || !activeChatOrderId) return; input.value = ""; await push(ref(db, `chats/${activeChatOrderId}/messages`), { senderId: currentUser.uid, text: text, timestamp: serverTimestamp(), seen: false }); update(ref(db, `chats/${activeChatOrderId}/typing/${currentUser.uid}`), false); };
        window.handleEnter = (e) => { if(e.key === 'Enter') sendMessage(); };
        window.previewAvatar=(e)=>{const f=e.target.files[0];if(f)document.getElementById('edit-avatar-preview').src=URL.createObjectURL(f);}
        window.saveProfile=async()=>{const n=document.getElementById('prof-name').value,p=document.getElementById('prof-phone').value,f=document.getElementById('profile-pic-input').files[0];toggleLoader(true);try{let url=currentUserProfile.profile?.avatarUrl;if(f)url=await uploadFile(f,'avatars');await update(ref(db,`users/${currentUser.uid}/profile`),{displayName:n,phone:p,avatarUrl:url,updatedAt:serverTimestamp()});showToast("Saved");showPage('profile');}catch(e){showCustomAlert("Error saving profile");}finally{toggleLoader(false);}};
        const uploadFile=(f,p)=>new Promise((res,rej)=>{const r=storageRef(storage,`${p}/${currentUser.uid}/${Date.now()}`);const t=uploadBytesResumable(r,f);t.on('state_changed',null,rej,()=>getDownloadURL(t.snapshot.ref).then(res));});
        window.openRating=(id)=>{currentOrderIdForRating=id;document.getElementById('rating-modal').classList.remove('hidden');};
        window.closeRating=()=>{document.getElementById('rating-modal').classList.add('hidden');};
        window.selectRating=(e)=>{document.querySelectorAll('.rating-chip-premium').forEach(c=>c.classList.remove('active'));e.classList.add('active');document.getElementById('rating-feedback').classList.remove('hidden');document.getElementById('rating-feedback').focus();};
        window.submitRating=async()=>{const s=document.querySelector('.rating-chip-premium.active');if(!s)return showCustomAlert("Select a rating option");toggleLoader(true);try{await update(ref(db,`orders/${currentUser.uid}/${currentOrderIdForRating}`),{rating:s.innerText.trim(),feedback:document.getElementById('rating-feedback').value});showToast("Feedback Submitted!");closeRating();}catch(e){showCustomAlert("Error submitting feedback");}finally{toggleLoader(false);}};
        window.toggleSavingsPopup = (show) => { const overlay = document.getElementById('savings-popup'); if (!overlay) return; if (show) { const competitorPrice = document.getElementById('rep-competitor').innerText; const spentPrice = document.getElementById('rep-spent').innerText; const savedPrice = document.getElementById('rep-saved').innerText; document.getElementById('popup-competitor-price').innerText = competitorPrice; document.getElementById('popup-spent-price').innerText = spentPrice; document.getElementById('popup-saved-price').innerText = savedPrice; overlay.classList.add('active'); } else { overlay.classList.remove('active'); } }
    </script>
</body>
</html>
